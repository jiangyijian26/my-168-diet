<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e" />
<meta name="description" content="å¥åº·é¥®é£Ÿ Pro 2.0 - ç§‘å­¦é¥®é£Ÿä¸é—´æ­‡æ€§æ–­é£ŸåŠ©æ‰‹" />
<title>å¥åº·é¥®é£Ÿ Pro 2.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #2d6a4f;
    --primary-light: #40916c;
    --primary-glow: rgba(45, 106, 79, 0.25);
    --accent: #d4a373;
    --accent-glow: rgba(212, 163, 115, 0.3);
    --success: #52b788;
    --success-glow: rgba(82, 183, 136, 0.25);
    --danger: #e07a5f;
    --danger-glow: rgba(224, 122, 95, 0.2);
    --warning: #e9c46a;
    --bg-body: #faf7f2;
    --bg-card: rgba(255, 255, 255, 0.82);
    --bg-glass: rgba(255, 255, 255, 0.92);
    --text-main: #1a1a2e;
    --text-sec: #6b705c;
    --text-ter: #a5a58d;
    --border: rgba(107, 112, 92, 0.12);
    --shadow-sm: 0 2px 12px rgba(26, 26, 46, 0.04);
    --shadow-md: 0 8px 30px rgba(26, 26, 46, 0.08);
    --shadow-lg: 0 20px 60px rgba(26, 26, 46, 0.12);
    --radius-xl: 24px;
    --radius-lg: 18px;
    --radius-md: 14px;
    --font-display: 'Playfair Display', Georgia, serif;
    --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}
[data-theme="dark"] {
    --primary: #74c69d;
    --primary-light: #95d5b2;
    --primary-glow: rgba(116, 198, 157, 0.2);
    --accent: #ddb892;
    --accent-glow: rgba(221, 184, 146, 0.2);
    --success: #74c69d;
    --success-glow: rgba(116, 198, 157, 0.2);
    --danger: #f4845f;
    --danger-glow: rgba(244, 132, 95, 0.15);
    --bg-body: #0d1b0e;
    --bg-card: rgba(20, 39, 22, 0.75);
    --bg-glass: rgba(13, 27, 14, 0.94);
    --text-main: #f0ead2;
    --text-sec: #b5c99a;
    --text-ter: #6b705c;
    --border: rgba(181, 201, 154, 0.1);
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.4);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
html, body { height: 100%; overflow-x: hidden; }
body {
    margin: 0; padding: 0;
    font-family: var(--font-body);
    background: var(--bg-body);
    color: var(--text-main);
    transition: background 0.5s ease, color 0.5s ease;
    position: relative;
}
body::before {
    content: '';
    position: fixed; inset: 0;
    background:
        radial-gradient(ellipse at 20% 0%, rgba(45,106,79,0.08), transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(212,163,115,0.06), transparent 60%);
    pointer-events: none; z-index: 0;
}
[data-theme="dark"] body::before {
    background:
        radial-gradient(ellipse at 20% 0%, rgba(116,198,157,0.06), transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(221,184,146,0.04), transparent 60%);
}

.container {
    max-width: 480px; margin: 0 auto;
    padding: calc(12px + env(safe-area-inset-top)) 18px calc(50px + env(safe-area-inset-bottom));
    min-height: 100vh;
    display: flex; flex-direction: column;
    position: relative; z-index: 1;
}

/* ===== TOPBAR ===== */
.topbar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 28px; padding-top: 12px;
}
.brand h1 {
    margin: 0; font-family: var(--font-display);
    font-size: 26px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.brand-badge {
    font-family: var(--font-body);
    font-size: 10px; color: #fff; background: var(--primary);
    padding: 3px 10px; border-radius: 100px; margin-left: 10px;
    vertical-align: middle; font-weight: 700;
    box-shadow: 0 2px 12px var(--primary-glow);
    -webkit-text-fill-color: #fff;
    letter-spacing: 0.5px;
}
.nav-actions { display: flex; gap: 10px; }
.icon-btn {
    width: 42px; height: 42px; border-radius: 14px; border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-main);
    display: grid; place-items: center; cursor: pointer; font-size: 17px;
    transition: all 0.3s var(--ease-spring);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
}
.icon-btn:active { transform: scale(0.88); }
.icon-btn:hover { box-shadow: var(--shadow-sm); }

/* ===== CARD ===== */
.card {
    background: var(--bg-card);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    padding: 22px; margin-bottom: 18px;
    position: relative; overflow: hidden;
    transition: transform 0.4s var(--ease-smooth), box-shadow 0.4s var(--ease-smooth);
}
.card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    opacity: 0.6;
}
[data-theme="dark"] .card::before { opacity: 0.15; }
.card:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }

/* ===== MODE TABS ===== */
.mode-tabs {
    display: flex;
    background: rgba(107, 112, 92, 0.06);
    padding: 4px; border-radius: var(--radius-lg); margin-bottom: 24px;
    position: relative;
}
[data-theme="dark"] .mode-tabs { background: rgba(181, 201, 154, 0.06); }
.tab {
    flex: 1; text-align: center; padding: 11px 0; font-size: 13px; font-weight: 700;
    color: var(--text-ter); border-radius: var(--radius-md); cursor: pointer; z-index: 2;
    transition: all 0.35s var(--ease-spring); position: relative;
}
.tab.active {
    background: var(--bg-card); color: var(--primary);
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
}
.tab-sub { font-size: 10px; font-weight: 600; opacity: 0.55; margin-top: 2px; }

/* ===== TIMER ===== */
.timer-section { position: relative; margin: 8px 0 28px; text-align: center; }
.timer-wrap {
    width: 250px; height: 250px; margin: 0 auto; position: relative;
    filter: drop-shadow(0 8px 25px var(--primary-glow));
}
.timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; overflow: visible; }
.timer-track { fill: none; stroke: var(--border); stroke-width: 10; stroke-linecap: round; }
.timer-progress {
    fill: none; stroke: url(#gradientMain); stroke-width: 10; stroke-linecap: round;
    stroke-dasharray: 722; stroke-dashoffset: 722;
    transition: stroke-dashoffset 1s linear;
}
.timer-content {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.timer-val {
    font-family: var(--font-display);
    font-size: 42px; font-weight: 800; font-variant-numeric: tabular-nums;
    letter-spacing: -1.5px; line-height: 1; margin-bottom: 6px;
    color: var(--text-main);
}
.timer-sub { font-size: 13px; font-weight: 600; color: var(--text-sec); margin-bottom: 10px; }
.timer-hint {
    font-size: 11px; color: var(--text-ter); font-weight: 600;
    background: rgba(107, 112, 92, 0.06);
    padding: 7px 14px; border-radius: 999px;
    display: inline-flex; gap: 6px; align-items: center;
    border: 1px solid var(--border);
}
[data-theme="dark"] .timer-hint { background: rgba(181, 201, 154, 0.06); }
.status-badge {
    padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700;
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(107, 112, 92, 0.06); color: var(--text-sec);
    transition: all 0.4s; margin-bottom: 10px;
}
.status-badge.fasting { background: var(--success-glow); color: var(--success); }
.status-badge.eating { background: var(--primary-glow); color: var(--primary); }
.status-badge.warn { background: var(--danger-glow); color: var(--danger); }
.pulse-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }

/* ===== MEAL GRID ===== */
.meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
.meal-card {
    background: var(--bg-card); border: 1.5px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px 16px;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    transition: all 0.35s var(--ease-spring); cursor: pointer; position: relative;
    min-height: 120px; overflow: hidden;
}
.meal-card::after {
    content: ''; position: absolute; inset: 0;
    border-radius: inherit;
    opacity: 0; transition: opacity 0.3s;
}
.meal-card.active { border-color: var(--primary); }
.meal-card.active::after { opacity: 1; background: linear-gradient(135deg, rgba(45,106,79,0.03), transparent); }
.meal-card.done { border-color: var(--success); }
.meal-card.done::after { opacity: 1; background: linear-gradient(135deg, rgba(82,183,136,0.03), transparent); }
.meal-card:active { transform: scale(0.96); }
.meal-emoji {
    font-size: 36px; margin-bottom: 10px; transition: 0.4s var(--ease-spring);
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}
.meal-card:hover .meal-emoji { transform: scale(1.15) rotate(8deg); }
.meal-title { font-weight: 700; font-size: 14px; margin-bottom: 5px; display:flex; align-items:center; gap:6px; justify-content:center; }
.meal-time { font-size: 11px; color: var(--text-ter); font-weight: 600; }
.mini-badge {
    font-size: 9px; font-weight: 800;
    padding: 3px 7px; border-radius: 999px;
    background: var(--primary-glow);
    border: 1px solid rgba(45,106,79,0.15);
    color: var(--primary);
}
[data-theme="dark"] .mini-badge { background: rgba(116,198,157,0.1); }
.deadline-chip {
    margin-top: 10px;
    font-size: 10px; font-weight: 700;
    padding: 5px 10px; border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(107, 112, 92, 0.04);
    color: var(--text-sec);
    display: inline-flex; align-items: center; gap: 5px;
    white-space: nowrap;
}
[data-theme="dark"] .deadline-chip { background: rgba(181,201,154,0.04); }
.deadline-chip.over { color: var(--danger); border-color: rgba(224,122,95,0.2); background: rgba(224,122,95,0.06); }
.deadline-chip.ok { color: var(--success); border-color: rgba(82,183,136,0.2); background: rgba(82,183,136,0.06); }

/* ===== EXTRA MEAL BTN ===== */
.extra-meal-btn {
    width: 100%;
    margin-bottom: 18px;
    background: rgba(224, 122, 95, 0.06);
    border: 1.5px dashed var(--danger);
    color: var(--danger);
    border-radius: var(--radius-lg);
    padding: 13px;
    font-weight: 700; font-size: 13px; font-family: var(--font-body);
    cursor: pointer;
    display: none;
    align-items: center; justify-content: center; gap: 8px;
    transition: all 0.3s;
}
.extra-meal-btn:active { transform: scale(0.98); background: rgba(224, 122, 95, 0.1); }
.extra-meal-item {
    background: rgba(224, 122, 95, 0.04);
    border: 1px solid rgba(224, 122, 95, 0.15);
    border-radius: 12px;
    padding: 10px 12px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: 0.2s;
}
.extra-meal-item:active { transform: scale(0.98); }

/* ===== METRICS ===== */
.metrics-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 14px; margin-bottom: 18px; }
.mini-control {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(107, 112, 92, 0.04); border-radius: 12px; padding: 5px; margin-top: 8px;
}
[data-theme="dark"] .mini-control { background: rgba(181,201,154,0.06); }
.circle-btn {
    width: 34px; height: 34px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-main); font-weight: 700;
    font-family: var(--font-body); font-size: 16px;
    box-shadow: var(--shadow-sm); cursor: pointer;
    transition: all 0.25s var(--ease-spring);
}
.circle-btn:active { transform: scale(0.9); }
.weight-inp {
    width: 70px; background: transparent; border: none; text-align: center;
    font-weight: 800; font-size: 16px; color: var(--text-main); font-family: var(--font-body);
}

/* ===== STATS ===== */
.stats-card { padding-bottom: 18px; }
.stats-header { display: flex; justify-content: space-around; margin-bottom: 20px; }
.stat-box { text-align: center; }
.stat-num {
    font-family: var(--font-display);
    font-size: 24px; font-weight: 800; display: block;
    color: var(--primary);
}
.stat-lbl { font-size: 10px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.8px; font-weight: 700; margin-top: 4px; }
.chart-container {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
    height: 100px; align-items: end; padding: 0 8px;
}
.chart-bar-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
.chart-bar {
    width: 8px; border-radius: 10px; background: var(--border);
    transition: height 0.8s var(--ease-spring), background 0.3s;
    min-height: 6px; position: relative;
}
.chart-bar.filled { background: var(--success); box-shadow: 0 0 12px var(--success-glow); }
.chart-bar.current { background: var(--primary); box-shadow: 0 0 12px var(--primary-glow); }
.chart-day { font-size: 10px; color: var(--text-ter); font-weight: 700; }

/* ===== SECTION LABEL ===== */
.section-label {
    font-size: 11px; color: var(--text-sec); font-weight: 700;
    margin-bottom: 8px; letter-spacing: 0.3px;
    display: flex; align-items: center; gap: 6px;
}

/* ===== OVERLAY & SHEETS ===== */
.overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 99; opacity: 0; pointer-events: none; transition: 0.4s;
}
.overlay.visible { opacity: 1; pointer-events: auto; }
.bottom-sheet {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--bg-glass); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-radius: 28px 28px 0 0;
    padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
    z-index: 100; transform: translateY(110%); transition: 0.5s var(--ease-spring);
    box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
    max-width: 560px; margin: 0 auto;
    max-height: min(85vh, 780px); overflow: auto;
}
.bottom-sheet.visible { transform: translateY(0); }
.sheet-handle {
    width: 36px; height: 4px; border-radius: 999px;
    background: var(--border); margin: 0 auto 16px;
}
.sheet-head { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
.sheet-head h2 {
    margin: 0; font-family: var(--font-display);
    font-size: 20px; letter-spacing: -0.3px;
}
.sheet-close {
    background: rgba(107,112,92,0.06); border: 1px solid var(--border);
    font-size: 18px; color: var(--text-ter); cursor: pointer;
    width: 36px; height: 36px; border-radius: 12px;
    display: grid; place-items: center; transition: 0.2s;
}
[data-theme="dark"] .sheet-close { background: rgba(181,201,154,0.06); }
.sheet-close:active { transform: scale(0.92); }

/* ===== INPUTS ===== */
.input-box {
    width: 100%; padding: 14px 16px; border-radius: var(--radius-md);
    border: 1.5px solid var(--border);
    background: rgba(107,112,92,0.03);
    font-size: 15px; color: var(--text-main); font-family: var(--font-body);
    margin-bottom: 12px; transition: all 0.3s;
}
[data-theme="dark"] .input-box { background: rgba(181,201,154,0.04); }
.input-box:focus { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }
textarea.input-box { resize: none; }

/* ===== BUTTONS ===== */
.btn {
    width: 100%; padding: 15px; border: none; border-radius: var(--radius-md);
    font-size: 15px; font-weight: 700; cursor: pointer; font-family: var(--font-body);
    display: flex; justify-content: center; align-items: center; gap: 8px;
    transition: all 0.25s var(--ease-spring); position: relative;
}
.btn:active { transform: scale(0.97); }
.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    box-shadow: 0 6px 20px var(--primary-glow);
}
.btn-primary:hover { box-shadow: 0 8px 28px var(--primary-glow); }
.btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text-main); }
.btn-text { background: transparent; color: var(--text-sec); font-size: 13px; margin-top: 10px; font-weight: 700; border: none; }
.spinner {
    width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
}
.btn.loading .spinner { display: block; }
.btn.loading span { display: none; }

/* ===== IMAGE UPLOAD AREA ===== */
.upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(107,112,92,0.02);
    margin-bottom: 14px;
    position: relative;
    overflow: hidden;
}
[data-theme="dark"] .upload-zone { background: rgba(181,201,154,0.02); }
.upload-zone:hover, .upload-zone.dragover {
    border-color: var(--primary);
    background: var(--primary-glow);
}
.upload-zone-icon {
    font-size: 40px; margin-bottom: 8px;
    filter: grayscale(0.3);
    transition: 0.3s var(--ease-spring);
}
.upload-zone:hover .upload-zone-icon { transform: scale(1.1); filter: grayscale(0); }
.upload-zone-text { font-size: 13px; font-weight: 600; color: var(--text-sec); }
.upload-zone-hint { font-size: 11px; color: var(--text-ter); margin-top: 4px; }
.upload-zone.has-image { padding: 0; border-style: solid; border-color: var(--success); }
.upload-zone.has-image img {
    width: 100%; height: auto; display: block;
    border-radius: calc(var(--radius-lg) - 2px);
}
.upload-zone-actions {
    display: flex; gap: 8px; margin-bottom: 14px;
}
.upload-zone-actions .btn { flex: 1; padding: 10px; font-size: 12px; }

/* ===== TOAST ===== */
.toast {
    position: fixed; top: calc(16px + env(safe-area-inset-top)); left: 50%;
    transform: translateX(-50%) scale(0.9) translateY(-10px); opacity: 0; pointer-events: none;
    background: var(--text-main); color: var(--bg-body);
    padding: 12px 20px; border-radius: 50px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    display: flex; align-items: center; gap: 8px; z-index: 999;
    transition: all 0.4s var(--ease-spring); font-weight: 700; font-size: 13px;
    max-width: calc(100vw - 32px);
    backdrop-filter: blur(10px);
}
.toast.visible { transform: translateX(-50%) scale(1) translateY(0); opacity: 1; }

/* ===== AUTH ===== */
.auth-tabs { display: flex; gap: 8px; margin-bottom: 18px; }
.auth-tab {
    flex: 1; text-align: center; padding: 10px; border-radius: 12px;
    font-weight: 700; color: var(--text-sec); cursor: pointer;
    background: rgba(107,112,92,0.04); border: 1.5px solid transparent;
    transition: all 0.3s; font-size: 13px;
}
[data-theme="dark"] .auth-tab { background: rgba(181,201,154,0.04); }
.auth-tab.active {
    background: var(--bg-card); color: var(--primary);
    border-color: var(--primary); box-shadow: 0 2px 12px var(--primary-glow);
}

/* ===== WEEK LIST ===== */
.week-list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
.week-item {
    border: 1px solid var(--border);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 12px 14px;
    display: flex; justify-content: space-between; align-items: center;
    gap: 10px; cursor: pointer; transition: all 0.25s;
}
.week-item:active { transform: scale(0.98); }
.week-item:hover { box-shadow: var(--shadow-sm); }
.week-left { display: flex; flex-direction: column; gap: 3px; }
.week-date { font-weight: 800; font-size: 13px; }
.week-sub { font-size: 11px; color: var(--text-sec); font-weight: 600; line-height: 1.4; }
.pill {
    font-size: 10px; font-weight: 800;
    padding: 5px 10px; border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--text-sec);
    background: rgba(107,112,92,0.04);
    white-space: nowrap;
}
[data-theme="dark"] .pill { background: rgba(181,201,154,0.04); }
.pill.ok { color: var(--success); border-color: rgba(82,183,136,0.2); background: rgba(82,183,136,0.06); }
.pill.run { color: var(--primary); border-color: rgba(45,106,79,0.2); background: rgba(45,106,79,0.06); }
.pill.miss { color: var(--danger); border-color: rgba(224,122,95,0.2); background: rgba(224,122,95,0.06); }

/* ===== DETAIL ===== */
.detail-box {
    border: 1px solid var(--border);
    background: rgba(107,112,92,0.02);
    border-radius: var(--radius-lg);
    padding: 14px;
    margin-top: 12px;
}
[data-theme="dark"] .detail-box { background: rgba(181,201,154,0.03); }
.detail-row { display:flex; justify-content:space-between; gap:10px; padding:7px 0; border-bottom:1px dashed var(--border); font-weight:600; }
.detail-row:last-child { border-bottom: none; }
.detail-k { color: var(--text-sec); font-size: 12px; }
.detail-v { color: var(--text-main); font-size: 12px; text-align: right; }

.upload-card {
    border: 1px solid var(--border);
    background: rgba(107,112,92,0.02);
    border-radius: var(--radius-lg);
    padding: 14px;
    display: flex; flex-direction: column; gap: 12px;
    margin-bottom: 12px;
}
[data-theme="dark"] .upload-card { background: rgba(181,201,154,0.03); }
.upload-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
.upload-h { font-weight: 800; font-size: 13px; }
.upload-sub { font-size: 11px; color: var(--text-ter); font-weight: 600; line-height: 1.4; }
.switch {
    width: 48px; height: 28px; border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(107,112,92,0.08);
    position: relative; cursor: pointer; flex: none;
    transition: all 0.3s var(--ease-spring);
}
[data-theme="dark"] .switch { background: rgba(181,201,154,0.08); }
.switch::after {
    content:""; width: 22px; height: 22px; border-radius: 50%; background: #fff;
    position:absolute; top: 2px; left: 3px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: 0.3s var(--ease-spring);
}
.switch.on { background: var(--primary-glow); border-color: var(--primary); }
.switch.on::after { left: 22px; background: var(--primary); }

.img-preview {
    width: 100%; border-radius: var(--radius-md); border: 1px solid var(--border);
    overflow: hidden; background: rgba(107,112,92,0.03); display:none;
}
[data-theme="dark"] .img-preview { background: rgba(181,201,154,0.04); }
.img-preview img { width: 100%; height: auto; display:block; }
.two-col { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.small-btn { padding: 10px; border-radius: 12px; font-weight: 800; font-size: 12px; }

.meal-media-grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
.meal-media-box {
    border: 1px solid var(--border); border-radius: var(--radius-md);
    background: rgba(107,112,92,0.02); padding: 12px;
}
[data-theme="dark"] .meal-media-box { background: rgba(181,201,154,0.03); }
.meal-media-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
.meal-media-head .t { font-weight: 800; font-size: 12px; }
.meal-media-head .s { font-size: 11px; color: var(--text-ter); font-weight: 700; }
.meal-media-img {
    width: 100%; border-radius: 12px; border: 1px solid var(--border); overflow:hidden;
    margin-bottom: 10px; display:none;
}
.meal-media-img img { width:100%; height:auto; display:block; }
.meal-media-note { font-size: 12px; color: var(--text-sec); font-weight: 600; line-height:1.5; white-space: pre-wrap; }

/* ===== LAUNCH SPLASH ===== */
.launch-splash {
    position: fixed; inset: 0; z-index: 3000;
    background: linear-gradient(135deg, #2d6a4f, #40916c, #d4a373);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #fff; text-align: center;
    opacity: 0; pointer-events: none; transition: opacity 0.6s ease;
}
.launch-splash.active { opacity: 1; pointer-events: auto; }
.launch-title {
    font-family: var(--font-display);
    font-size: 34px; font-weight: 900; margin-bottom: 10px; animation: bounceIn 0.8s;
}
.launch-sub { font-size: 15px; font-weight: 500; opacity: 0.85; animation: fadeIn 1.2s; }

/* ===== ANIMATIONS ===== */
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 1; transform: scale(1); } }
@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.95); }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.anim-in { animation: slideUp 0.5s var(--ease-smooth) both; }
.anim-d1 { animation-delay: 0.05s; }
.anim-d2 { animation-delay: 0.1s; }
.anim-d3 { animation-delay: 0.15s; }
.anim-d4 { animation-delay: 0.2s; }
.anim-d5 { animation-delay: 0.25s; }

#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 200; }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="launch-splash" id="launchSplash">
<div style="font-size:56px; margin-bottom:12px; filter: drop-shadow(0 4px 20px rgba(0,0,0,0.2));">ğŸŒ¿</div>
<div class="launch-title">å¥åº·é¥®é£Ÿ Pro</div>
<div class="launch-sub">å…¨æ–° 2.0 Â· ç§‘å­¦æ–­é£Ÿ Â· ä¼˜é›…è®°å½•</div>
</div>

<div class="container">
<div class="topbar anim-in">
<div class="brand">
<h1>å¥åº·é¥®é£Ÿ<span style="font-weight:400; opacity:0.7;"> Pro</span><span class="brand-badge">2.0</span></h1>
</div>
<div class="nav-actions">
<button class="icon-btn" id="themeBtn" title="ä¸»é¢˜">ğŸŒ“</button>
<button class="icon-btn" id="userBtn" title="äº‘åŒæ­¥">â˜ï¸</button>
</div>
</div>

<div class="mode-tabs anim-in anim-d1">
<div class="tab" data-mode="12">12:12<div class="tab-sub">å…¥é—¨</div></div>
<div class="tab" data-mode="14">14:10<div class="tab-sub">æ—¥å¸¸</div></div>
<div class="tab active" data-mode="16">16:8<div class="tab-sub">ç‡ƒè„‚</div></div>
<div class="tab" data-mode="18">18:6<div class="tab-sub">è¿›é˜¶</div></div>
</div>

<div class="card timer-section anim-in anim-d2">
<div class="timer-wrap">
<svg class="timer-svg" viewBox="0 0 240 240">
<defs>
<linearGradient id="gradientMain" x1="0%" y1="0%" x2="100%" y2="100%">
<stop offset="0%" stop-color="#2d6a4f" />
<stop offset="100%" stop-color="#74c69d" />
</linearGradient>
<linearGradient id="gradientSuccess" x1="0%" y1="0%" x2="100%" y2="100%">
<stop offset="0%" stop-color="#52b788" />
<stop offset="100%" stop-color="#95d5b2" />
</linearGradient>
</defs>
<circle class="timer-track" cx="120" cy="120" r="115"></circle>
<circle class="timer-progress" id="progressRing" cx="120" cy="120" r="115"></circle>
</svg>
<div class="timer-content">
<div class="timer-val" id="timerDisplay">--:--</div>
<div class="timer-sub" id="timerLabel">å‡†å¤‡å¼€å§‹</div>
<div class="status-badge" id="statusBadge">
<div class="pulse-dot"></div>
<span id="statusText">ç©ºè…¹æœŸ</span>
</div>
<div class="timer-hint" id="timerHint" style="display:none;">â±ï¸ <span id="timerHintText">â€”</span></div>
</div>
</div>
</div>

<div class="meal-grid anim-in anim-d3">
<div class="meal-card" id="btnStartFast">
<div class="meal-emoji">ğŸ³</div>
<div class="meal-title">
ç¬¬ä¸€é¤ <span class="mini-badge" id="mediaBadgeStart" style="display:none;">ğŸ“·</span>
</div>
<div class="meal-time" id="startLabel">ç‚¹å‡»å¼€å§‹æ‰“å¡</div>
</div>
<div class="meal-card" id="btnEndFast">
<div class="meal-emoji">ğŸŒ™</div>
<div class="meal-title">
æœ€åä¸€é¤ <span class="mini-badge" id="mediaBadgeEnd" style="display:none;">ğŸ“·</span>
</div>
<div class="meal-time" id="endLabel">ç­‰å¾…å¼€å§‹</div>
<div class="deadline-chip" id="deadlineChip" style="display:none;">â³ æœ€æ™šå¯è¿›é£Ÿè‡³ï¼š--:--</div>
</div>
</div>

<button class="extra-meal-btn" id="btnExtraMeal">
<span>ğŸ˜« æ²¡å¿ä½ / é¢å¤–åŠ é¤</span>
</button>

<div class="card anim-in anim-d4" style="padding: 18px;">
<div class="section-label">ğŸ—‚ï¸ ä»Šæ—¥èµ„æ–™ / å¤‡æ³¨</div>
<textarea id="noteInput" class="input-box" rows="3" placeholder="ä»Šå¤©åƒäº†ä»€ä¹ˆã€è®­ç»ƒ/ä½œæ¯ã€èº«ä½“æ„Ÿå—â€¦"></textarea>
<button class="btn btn-outline" id="noteSaveBtn"><span>ä¿å­˜èµ„æ–™</span><div class="spinner"></div></button>
<div style="font-size:10px; color:var(--text-ter); margin-top:8px; font-weight:600;">ç™»å½•åè‡ªåŠ¨äº‘ç«¯åŒæ­¥</div>
</div>

<div class="metrics-row anim-in anim-d4">
<div class="card" style="margin:0; display:flex; flex-direction:column; justify-content:center;">
<div class="section-label">ğŸ’§ é¥®æ°´ (æ¯)</div>
<div class="mini-control">
<button class="circle-btn" id="waterMinus">âˆ’</button>
<span style="font-weight:800; font-size:20px; color:var(--primary); font-family:var(--font-display);" id="waterCount">0</span>
<button class="circle-btn" id="waterPlus" style="color:var(--primary);">+</button>
</div>
</div>
<div class="card" style="margin:0; display:flex; flex-direction:column; justify-content:center;">
<div class="section-label">âš–ï¸ ä½“é‡ (kg)</div>
<div class="mini-control">
<input type="number" class="weight-inp" id="weightInput" placeholder="0.0" step="0.1">
<button class="circle-btn" id="weightSaveBtn" style="width:auto; padding:0 12px; font-size:11px;">ä¿å­˜</button>
</div>
</div>
</div>

<div class="card stats-card anim-in anim-d5">
<div class="stats-header">
<div class="stat-box">
<span class="stat-num" id="statStreak">0</span>
<span class="stat-lbl">ğŸ”¥ è¿ç»­</span>
</div>
<div class="stat-box">
<span class="stat-num" id="statTotal">0</span>
<span class="stat-lbl">ğŸ“… ç´¯è®¡</span>
</div>
<div class="stat-box">
<span class="stat-num" id="statRate">0%</span>
<span class="stat-lbl">ğŸ“ˆ å®Œæˆç‡</span>
</div>
</div>
<div style="height:1px; background:var(--border); margin-bottom:16px;"></div>
<div class="chart-container" id="weekChart"></div>
</div>

<div class="card anim-in anim-d5" style="padding: 18px;">
<div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
<div>
<div class="section-label" style="margin-bottom:2px;">ğŸ“š è¿‘ä¸€å‘¨è®°å½•</div>
<div style="font-size:10px; color:var(--text-ter); font-weight:600; margin-top:4px;">å«æ‰“å¡ã€é¥®æ°´ã€ä½“é‡ã€é¤å›¾ä¸ç•™è¨€</div>
</div>
<button class="icon-btn" id="weekBtn" title="æŸ¥çœ‹è¿‘ä¸€å‘¨" style="width:44px; height:44px;">ğŸ—“ï¸</button>
</div>
</div>

<div style="margin-top:auto; text-align:center; padding-top:10px;">
<button class="btn-text" id="resetBtn">é‡ç½®ä»Šæ—¥çŠ¶æ€</button>
</div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Auth Sheet -->
<div class="bottom-sheet" id="authSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-head">
        <h2 id="authTitle">â˜ï¸ ç™»å½•è´¦å·</h2>
        <button class="sheet-close" id="authClose">âœ•</button>
    </div>
    <div class="auth-tabs">
        <div class="auth-tab active" id="tabLogin">ç™»å½•</div>
        <div class="auth-tab" id="tabRegister">æ³¨å†Œ</div>
    </div>
    <div id="authForm">
        <input type="email" class="input-box" id="authEmail" placeholder="ç”µå­é‚®ç®±">
        <input type="password" class="input-box" id="authPwd" placeholder="å¯†ç  (6ä½ä»¥ä¸Š)">
        <button class="btn btn-primary" id="btnAuthAction" style="margin-bottom:12px;">
            <span id="btnAuthText">ç™»å½• / åŒæ­¥</span><div class="spinner"></div>
        </button>
        <div style="text-align:center; font-size:11px; color:var(--text-ter); margin-top:8px;">
            Powered by Supabase
        </div>
        <div class="upload-card" style="margin-top:14px;">
            <div class="upload-row">
                <div>
                    <div class="upload-h">ğŸ“· ä¸Šä¼ å›¾ç‰‡ & ç•™è¨€</div>
                    <div class="upload-sub">å¯é€‰ï¼Œç™»å½•åæ•°æ®å°†ä¿å­˜åˆ°äº‘ç«¯ã€‚</div>
                </div>
                <div class="switch" id="toggleMealMedia"></div>
            </div>
            <div class="upload-sub" id="toggleHint">æœªç™»å½•ï¼šä»…æœ¬æœºç”Ÿæ•ˆï¼›ç™»å½•åï¼šå¤šç«¯åŒæ­¥ã€‚</div>
        </div>
    </div>
    <div id="userPanel" style="display:none; text-align:center; padding:10px 0 0;">
        <div style="font-size:50px; margin-bottom:10px; animation: pulse 3s infinite;">ğŸ‰</div>
        <h3 id="userEmailDisplay" style="margin:0 0 6px; font-family:var(--font-display);"></h3>
        <p style="color:var(--text-sec); font-size:13px; margin:0 0 18px; font-weight:600;">æ•°æ®å·²å®æ—¶å¤‡ä»½è‡³ Supabase Cloud</p>
        <div class="upload-card" style="text-align:left;">
            <div class="upload-row">
                <div>
                    <div class="upload-h">ğŸ“· ä¸Šä¼ å›¾ç‰‡ & ç•™è¨€</div>
                    <div class="upload-sub">å·²ç™»å½•ï¼šè®¾ç½®å·²åŒæ­¥ã€‚</div>
                </div>
                <div class="switch" id="toggleMealMedia2"></div>
            </div>
        </div>
        <button class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); margin-bottom:10px;" id="btnLogout">é€€å‡ºç™»å½•</button>
        <button class="btn btn-outline" id="btnForcePull">ä»äº‘ç«¯å¼ºåˆ¶æ‹‰å–</button>
    </div>
</div>

<!-- Week Sheet -->
<div class="bottom-sheet" id="weekSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-head">
        <h2>ğŸ—“ï¸ è¿‘ä¸€å‘¨æ‰“å¡</h2>
        <button class="sheet-close" id="weekClose">âœ•</button>
    </div>
    <div id="weekListContainer">
        <div style="font-size:11px; color:var(--text-sec); font-weight:600; margin-bottom:10px;">
        ç‚¹å‡»æŸä¸€å¤©æŸ¥çœ‹è¯¦æƒ…
        </div>
        <div class="week-list" id="weekList"></div>
    </div>
    <div id="dayDetail" class="detail-box" style="display:none; border:none; background:transparent; padding:0; margin-top:0;">
        <button class="btn-text" id="btnBackToWeek" style="margin-bottom:10px; text-align:left; padding-left:0; font-size:13px;">
        â† è¿”å›åˆ—è¡¨
        </button>
        <div class="detail-box" style="background:var(--bg-card); margin-top:0;">
            <div style="font-weight:800; margin-bottom:8px; font-size:13px; font-family:var(--font-display);" id="detailTitle">â€”</div>
            <div class="detail-row"><div class="detail-k">æ¨¡å¼</div><div class="detail-v" id="d_mode">â€”</div></div>
            <div class="detail-row"><div class="detail-k">ç¬¬ä¸€é¤</div><div class="detail-v" id="d_start">â€”</div></div>
            <div class="detail-row"><div class="detail-k">æœ€åä¸€é¤</div><div class="detail-v" id="d_end">â€”</div></div>
            <div class="detail-row"><div class="detail-k">è¿›é£Ÿçª—å£</div><div class="detail-v" id="d_eatwin">â€”</div></div>
            <div class="detail-row"><div class="detail-k">é¥®æ°´</div><div class="detail-v" id="d_water">â€”</div></div>
            <div class="detail-row"><div class="detail-k">ä½“é‡</div><div class="detail-v" id="d_weight">â€”</div></div>
            <div class="detail-row"><div class="detail-k">èµ„æ–™å¤‡æ³¨</div><div class="detail-v" id="d_note">â€”</div></div>
            <div id="d_extra_area" style="display:none; border-top:1px dashed var(--danger); margin-top:10px; padding-top:10px;">
                <div style="font-size:11px; color:var(--danger); font-weight:700; margin-bottom:6px;">âš ï¸ é¢å¤–è¿›é£Ÿè®°å½•</div>
                <div id="d_extra_list"></div>
            </div>
            <div class="meal-media-grid">
                <div class="meal-media-box">
                    <div class="meal-media-head">
                        <div class="t">ğŸ³ ç¬¬ä¸€é¤ï¼šå›¾ç‰‡/ç•™è¨€</div>
                        <div class="s" id="d_s_time">â€”</div>
                    </div>
                    <div class="meal-media-img" id="d_s_img"><img alt="ç¬¬ä¸€é¤å›¾ç‰‡"></div>
                    <div class="meal-media-note" id="d_s_note">â€”</div>
                </div>
                <div class="meal-media-box">
                    <div class="meal-media-head">
                        <div class="t">ğŸŒ™ æœ€åä¸€é¤ï¼šå›¾ç‰‡/ç•™è¨€</div>
                        <div class="s" id="d_e_time">â€”</div>
                    </div>
                    <div class="meal-media-img" id="d_e_img"><img alt="æœ€åä¸€é¤å›¾ç‰‡"></div>
                    <div class="meal-media-note" id="d_e_note">â€”</div>
                </div>
            </div>
            <div style="margin-top:10px; font-size:10px; color:var(--text-ter); font-weight:600;" id="d_sync">â€”</div>
        </div>
    </div>
</div>

<!-- View Meal Sheet -->
<div class="bottom-sheet" id="viewMealSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-head">
        <h2 id="viewMealTitle">ğŸ³ æ‰“å¡è¯¦æƒ…</h2>
        <button class="sheet-close" id="viewMealClose">âœ•</button>
    </div>
    <div class="upload-card">
        <div class="upload-row">
            <div class="upload-h">ğŸ•’ æ‰“å¡æ—¶é—´</div>
            <div class="upload-sub" id="viewMealTimeStr" style="font-size:14px; font-weight:700; color:var(--primary);">--:--</div>
        </div>
    </div>
    <div class="meal-media-box" style="margin-bottom:12px;">
        <div class="meal-media-head">
            <div class="t">ğŸ“· å›¾ç‰‡è®°å½•</div>
        </div>
        <div class="meal-media-img" id="viewMealImgBox" style="display:block;">
            <img id="viewMealImgTag" alt="å›¾ç‰‡" />
        </div>
        <div class="upload-sub" id="viewMealNoImg" style="display:none; text-align:center; padding:10px;">æš‚æ— å›¾ç‰‡</div>
    </div>
    <div class="upload-card">
        <div class="upload-h" style="margin-bottom:6px;">ğŸ’¬ ç•™è¨€å¤‡æ³¨</div>
        <div class="meal-media-note" id="viewMealNoteStr">æš‚æ— ç•™è¨€</div>
    </div>
    <button class="btn btn-primary" id="btnEditMeal" style="margin-bottom:10px;">
        âœï¸ è¡¥å½•å›¾ç‰‡ / ä¿®æ”¹ç•™è¨€
    </button>
    <button class="btn btn-outline" id="viewMealOkBtn">å…³é—­</button>
</div>

<!-- Meal Check-in Sheet (Enhanced Image Upload) -->
<div class="bottom-sheet" id="mealSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-head">
        <h2 id="mealSheetTitle">ğŸ³ æ‰“å¡</h2>
        <button class="sheet-close" id="mealClose">âœ•</button>
    </div>
    <div class="upload-card">
        <div class="upload-h" id="mealSheetSub">â€”</div>
        <div class="upload-sub" id="mealSheetHint">å¯é€‰ï¼šæ·»åŠ é£Ÿç‰©å›¾ç‰‡ä¸ç•™è¨€ã€‚</div>
    </div>

    <!-- Enhanced Image Upload Zone -->
    <div class="upload-zone" id="uploadZone">
        <div class="upload-zone-icon">ğŸ“¸</div>
        <div class="upload-zone-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ æˆ– æ‹–æ‹½ä¸Šä¼ </div>
        <div class="upload-zone-hint">æ”¯æŒæ‹ç…§ Â· è‡ªåŠ¨å‹ç¼© Â· Base64å­˜å‚¨</div>
    </div>
    <input id="mealImgInput" type="file" accept="image/*" capture="environment" style="display:none;">

    <!-- Image Preview & Actions (hidden until image selected) -->
    <div id="imgPreviewArea" style="display:none; margin-bottom:14px;">
        <div class="img-preview" id="mealImgPreview" style="display:block; margin-bottom:8px;"><img alt="é¢„è§ˆ"></div>
        <div class="upload-zone-actions">
            <button class="btn btn-outline small-btn" id="btnChangeImg"><span>æ›´æ¢å›¾ç‰‡</span></button>
            <button class="btn btn-outline small-btn" id="btnRemoveImg" style="border-color:var(--danger); color:var(--danger);"><span>ç§»é™¤å›¾ç‰‡</span></button>
        </div>
    </div>

    <div class="upload-card" id="mealMediaArea">
        <div class="upload-h">ğŸ’¬ ç•™è¨€ï¼ˆå¯é€‰ï¼‰</div>
        <textarea id="mealMsgInput" class="input-box" rows="3" placeholder="ä»Šå¤©åƒäº†ä»€ä¹ˆã€å¿ƒæƒ…å¦‚ä½•â€¦" style="margin-bottom:0;"></textarea>
    </div>

    <div class="upload-sub" id="mealCloudWarn" style="display:none; margin-bottom:10px; padding:0 4px;">
        âš ï¸ æœªç™»å½•ï¼šå›¾ç‰‡/ç•™è¨€ä¼šå…ˆä¿å­˜åœ¨æœ¬æœºï¼›ç™»å½•åæ‰ä¼šåŒæ­¥åˆ°äº‘ç«¯ã€‚
    </div>
    <div class="upload-sub" id="mealSizeWarn" style="display:none; margin-bottom:10px; padding:0 4px;">
        âš ï¸ å›¾ç‰‡è¿‡å¤§ï¼šå·²å°½åŠ›å‹ç¼©ï¼Œä»å¯èƒ½å› æ•°æ®åº“é™åˆ¶æ— æ³•ä¿å­˜å›¾ç‰‡ã€‚
    </div>

    <button class="btn btn-primary" id="mealConfirmBtn" style="margin-bottom:10px;"><span>âœ“ ç¡®è®¤æ‰“å¡</span><div class="spinner"></div></button>
    <button class="btn btn-outline" id="mealSkipBtn"><span>è·³è¿‡ï¼Œç›´æ¥æ‰“å¡</span><div class="spinner"></div></button>
</div>

<!-- Toast -->
<div class="toast" id="toast">
<span id="toastIcon">âœ…</span>
<span id="toastMsg">æ“ä½œæˆåŠŸ</span>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

/* ================= é…ç½®åŒº ================= */
const supabaseUrl = 'https://mjssiorvprbeuvdnbxkw.supabase.co'
const supabaseKey = 'sb_publishable_0nfL1jDXViLVQUffJfKSFA_vSdCXrco'
const supabase = createClient(supabaseUrl, supabaseKey)

const MODES = {
    12: { eat: 12, fast: 12 },
    14: { eat: 10, fast: 14 },
    16: { eat: 8, fast: 16 },
    18: { eat: 6, fast: 18 }
};

/* ================= å·¥å…·å‡½æ•° ================= */
const STORAGE_KEY = 'fasting_pro_v5_state';
const PREF_KEY = 'fasting_pro_v5_prefs';
const HISTORY_KEY = 'fasting_pro_v5_history';
const TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const pad2 = n => String(n).padStart(2, '0');
const dateKeyLocal = (d = new Date()) => {
    const y = d.getFullYear();
    const m = pad2(d.getMonth() + 1);
    const day = pad2(d.getDate());
    return `${y}-${m}-${day}`;
};
const fmtTime = (ms) => {
    if (!ms) return null;
    const d = new Date(ms);
    return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
};
const fmtDateCN = (key) => {
    const [y, m, d] = key.split('-');
    return `${y}/${m}/${d}`;
};
const msToHMS = (ms) => {
    const sign = ms < 0 ? '-' : '';
    const x = Math.abs(ms);
    const h = Math.floor(x / 3600000);
    const m = Math.floor((x % 3600000) / 60000);
    const s = Math.floor((x % 60000) / 1000);
    return `${sign}${h}:${pad2(m)}:${pad2(s)}`;
};
const showToast = (msg, icon = 'âœ…', type = 'normal') => {
    const t = $('toast');
    $('toastMsg').innerText = msg;
    $('toastIcon').innerText = icon;
    t.style.background = type === 'error'
        ? 'var(--danger)'
        : (document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(240,234,210,0.95)' : 'rgba(26,26,46,0.92)');
    t.style.color = type === 'error'
        ? '#fff'
        : (document.documentElement.getAttribute('data-theme') === 'dark' ? '#0d1b0e' : '#fff');
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 2500);
};
const fireConfetti = () => {
    const canvas = $('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const particles = [];
    const colors = ['#2d6a4f', '#52b788', '#d4a373', '#e9c46a', '#74c69d'];
    for(let i=0; i<120; i++) {
        particles.push({
            x: canvas.width / 2, y: canvas.height / 2,
            vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15 - 8,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: 4 + Math.random() * 6,
            life: 150, rot: Math.random() * 360
        });
    }
    const animate = () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let active = false;
        particles.forEach(p => {
            if(p.life > 0) {
                p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life--; p.rot += 5;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.min(1, p.life / 30);
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.6);
                ctx.restore();
                active = true;
            }
        });
        if(active) requestAnimationFrame(animate);
        else ctx.clearRect(0,0,canvas.width,canvas.height);
    };
    animate();
};
const btnLoading = (id, loading) => {
    const btn = $(id);
    if (!btn) return;
    if(loading) { btn.classList.add('loading'); btn.disabled = true; }
    else { btn.classList.remove('loading'); btn.disabled = false; }
};
const toggleSheet = (id, show) => {
    const s = $(id), o = $('overlay');
    if (show) { s.classList.add('visible'); o.classList.add('visible'); }
    else { s.classList.remove('visible'); o.classList.remove('visible'); }
    if (id === 'weekSheet' && !show) {
        setTimeout(() => {
            $('weekListContainer').style.display = 'block';
            $('dayDetail').style.display = 'none';
        }, 500);
    }
};
const toggleAuth = (show) => toggleSheet('authSheet', show);
const toggleWeek = (show) => toggleSheet('weekSheet', show);
const toggleMeal = (show) => toggleSheet('mealSheet', show);
const toggleViewMeal = (show) => toggleSheet('viewMealSheet', show);

/* ================= æœ¬åœ°æ•°æ®ç®¡ç† ================= */
let prefs = { mealMediaEnabled: true };
let dayMap = {};
let state = {
    dateKey: dateKeyLocal(),
    mode: 16,
    startTime: null,
    endTime: null,
    water: 0,
    weight: null,
    note: "",
    startMeal: { note: "", imageBase64: "" },
    endMeal: { note: "", imageBase64: "" },
    extraMeals: [],
    updatedAt: 0
};
let currentUser = null;

const loadLocal = () => {
    try {
        const rawPrefs = localStorage.getItem(PREF_KEY);
        if (rawPrefs) prefs = { ...prefs, ...JSON.parse(rawPrefs) };
        const rawHistory = localStorage.getItem(HISTORY_KEY);
        if (rawHistory) dayMap = JSON.parse(rawHistory);
        const rawState = localStorage.getItem(STORAGE_KEY);
        if (rawState) state = { ...state, ...JSON.parse(rawState) };
        if (!state.extraMeals) state.extraMeals = [];
    } catch(e) { console.error("Local Load Error", e); }
};

const saveLocal = () => {
    localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    dayMap[state.dateKey] = { ...state };
    localStorage.setItem(HISTORY_KEY, JSON.stringify(dayMap));
    syncToggleUI();
};

const ensureToday = () => {
    const today = dateKeyLocal();
    if (state.dateKey !== today) {
        state = {
            dateKey: today, mode: state.mode,
            startTime: null, endTime: null,
            water: 0, weight: state.weight || null, note: "",
            startMeal: { note:"", imageBase64:"" },
            endMeal: { note:"", imageBase64:"" },
            extraMeals: [],
            updatedAt: Date.now()
        };
        saveLocal();
    }
};

/* ================= Supabase äº‘åŒæ­¥ ================= */
const cloudSync = async () => {
    if (!currentUser) return;
    const fullPayload = { days: dayMap, prefs: prefs, lastSync: Date.now() };
    const { error } = await supabase.from('diet_logs').upsert({ user_id: currentUser.id, data: fullPayload }, { onConflict: 'user_id' });
    if (error) console.error("Cloud Sync Failed", error);
};

const cloudPull = async (force = false) => {
    if (!currentUser) return;
    const { data, error } = await supabase.from('diet_logs').select('data').eq('user_id', currentUser.id).single();
    if (data && data.data) {
        const cloudData = data.data;
        if (cloudData.days) dayMap = { ...dayMap, ...cloudData.days };
        if (cloudData.prefs) prefs = { ...prefs, ...cloudData.prefs };
        const today = dateKeyLocal();
        if (dayMap[today]) {
            if (force || (dayMap[today].updatedAt || 0) > (state.updatedAt || 0)) {
                state = dayMap[today];
                if (!state.extraMeals) state.extraMeals = [];
            }
        }
        saveLocal();
        renderUI();
        if(force) showToast('å·²ä»äº‘ç«¯æ¢å¤æ•°æ®', 'â˜ï¸');
    }
};

/* ================= å›¾ç‰‡å¤„ç† ================= */
const fileToImage = async (file) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.src = url;
    try {
        await new Promise((res, rej) => {
            img.onload = () => res();
            img.onerror = () => rej(new Error("image load failed"));
        });
        return { img, url };
    } catch (e) {
        URL.revokeObjectURL(url);
        throw e;
    }
};
const canvasToBlob = (canvas, quality) => new Promise((res) => canvas.toBlob(res, 'image/jpeg', quality));
const compressImageSmart = async (file, opts = {}) => {
    const maxSideStart = opts.maxSideStart ?? 1024;
    const minSide = opts.minSide ?? 600;
    const qStart = opts.qStart ?? 0.7;
    const qMin = opts.qMin ?? 0.4;
    const targetBytes = opts.targetBytes ?? (180 * 1024);
    const { img, url } = await fileToImage(file);
    try {
        const w0 = img.naturalWidth || img.width;
        const h0 = img.naturalHeight || img.height;
        let maxSide = maxSideStart;
        let quality = qStart;
        let best = null;
        for (let attempt = 0; attempt < 8; attempt++) {
            let nw = w0, nh = h0;
            const scale = Math.min(1, maxSide / Math.max(w0, h0));
            nw = Math.round(w0 * scale);
            nh = Math.round(h0 * scale);
            const canvas = document.createElement('canvas');
            canvas.width = nw; canvas.height = nh;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, nw, nh);
            const blob = await canvasToBlob(canvas, quality);
            if (!blob) throw new Error("toBlob failed");
            if (!best || blob.size < best.size) best = blob;
            if (blob.size <= targetBytes) return { blob, ok: true, size: blob.size };
            if (quality > qMin) quality = Math.max(qMin, quality - 0.1);
            else if (maxSide > minSide) { maxSide = Math.max(minSide, Math.round(maxSide * 0.8)); quality = qStart; }
            else break;
        }
        return { blob: best, ok: false, size: best?.size ?? 0 };
    } finally { URL.revokeObjectURL(url); }
};
const blobToBase64Raw = (blob) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const s = String(reader.result || "");
            const idx = s.indexOf(',');
            resolve(idx >= 0 ? s.slice(idx + 1) : s);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
};
const base64ToDataUrl = (b64) => b64 ? `data:image/jpeg;base64,${b64}` : "";

/* ================= UI æ¸²æŸ“ ================= */
const syncToggleUI = () => {
    const on = !!prefs.mealMediaEnabled;
    const a = $('toggleMealMedia');
    const b = $('toggleMealMedia2');
    if (a) a.classList.toggle('on', on);
    if (b) b.classList.toggle('on', on);
};

const renderUI = () => {
    ensureToday();
    $$('.tab').forEach(t => t.classList.toggle('active', +t.dataset.mode === state.mode));
    $('waterCount').innerText = state.water;
    if (state.weight !== null && state.weight !== undefined && state.weight !== '') $('weightInput').value = state.weight;
    $('noteInput').value = state.note || '';

    const bStart = $('btnStartFast');
    const bEnd = $('btnEndFast');
    const badge = $('statusBadge');
    const ring = $('progressRing');

    bStart.className = 'meal-card';
    bEnd.className = 'meal-card';
    ring.style.stroke = 'url(#gradientMain)';

    const chip = $('deadlineChip');
    if(state.startTime) {
        const eatMs = MODES[state.mode].eat * 3600000;
        const deadline = state.startTime + eatMs;
        const now = Date.now();
        const endStr = fmtTime(deadline);
        chip.style.display = 'inline-flex';
        chip.innerText = `â³ æœ€æ™šå¯è¿›é£Ÿè‡³ï¼š${endStr}`;
        chip.classList.remove('ok', 'over');
        if (deadline - now >= 0) chip.classList.add('ok');
        else chip.classList.add('over');
    } else {
        chip.style.display = 'none';
    }

    const sBadge = $('mediaBadgeStart');
    const eBadge = $('mediaBadgeEnd');
    const hasS = !!(state.startMeal?.imageBase64 || (state.startMeal?.note && state.startMeal.note.trim()));
    const hasE = !!(state.endMeal?.imageBase64 || (state.endMeal?.note && state.endMeal.note.trim()));
    sBadge.style.display = hasS ? 'inline-block' : 'none';
    eBadge.style.display = hasE ? 'inline-block' : 'none';

    const startStr = fmtTime(state.startTime);
    const endStr = fmtTime(state.endTime);

    if (state.endTime) {
        $('btnExtraMeal').style.display = 'flex';
    } else {
        $('btnExtraMeal').style.display = 'none';
    }

    if (!state.startTime) {
        $('statusText').innerText = 'ç©ºè…¹æœŸ';
        badge.className = 'status-badge fasting';
        $('timerHint').style.display = 'none';
        bStart.classList.add('active');
        $('startLabel').innerText = 'ç‚¹å‡»å¼€å§‹æ‰“å¡';
        $('endLabel').innerText = 'ç­‰å¾…å¼€å§‹';
    } else if (!state.endTime) {
        $('statusText').innerText = 'è¿›é£Ÿçª—å£';
        badge.className = 'status-badge eating';
        ring.style.stroke = 'url(#gradientSuccess)';
        bStart.classList.add('done');
        $('startLabel').innerText = 'å¼€å§‹äº ' + startStr;
        bEnd.classList.add('active');
        $('endLabel').innerText = 'ç‚¹å‡»æœ€åä¸€é¤æ‰“å¡';
    } else {
        $('statusText').innerText = 'ç¦é£ŸæœŸ';
        badge.className = 'status-badge fasting';
        bStart.classList.add('done');
        $('startLabel').innerText = startStr;
        bEnd.classList.add('done');
        $('endLabel').innerText = endStr;
    }
    calcStats();
    renderChart();
    renderWeekList();
    updateTimer();
};

const updateTimer = () => {
    const ring = $('progressRing');
    const circum = 722;
    if (!state.startTime) {
        ring.style.strokeDashoffset = circum;
        $('timerDisplay').innerText = '--:--';
        $('timerLabel').innerText = 'ç­‰å¾…æ‰“å¡';
        $('timerHint').style.display = 'none';
        return;
    }
    const now = Date.now();
    let percent = 0, display = "", label = "", hint = "";

    if (!state.endTime) {
        const eatDur = MODES[state.mode].eat * 3600000;
        const end = state.startTime + eatDur;
        const left = end - now;
        const passed = now - state.startTime;
        if (left > 0) {
            percent = Math.min(1, Math.max(0, passed / eatDur));
            display = msToHMS(left);
            label = 'è·ç¦»çª—å£å…³é—­';
            hint = `æœ€æ™šå¯è¿›é£Ÿè‡³ ${fmtTime(end)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        } else {
            percent = 1;
            display = "00:00:00";
            label = "å·²è¶…æ—¶";
            hint = `å·²è¶…è¿‡çª—å£å…³é—­æ—¶é—´ ${fmtTime(end)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.add('warn');
        }
    } else {
        const fastDur = MODES[state.mode].fast * 3600000;
        const nextEat = state.endTime + fastDur;
        const left = nextEat - now;
        const passed = now - state.endTime;
        percent = Math.min(1, Math.max(0, passed / fastDur));
        if (left > 0) {
            display = msToHMS(left);
            label = 'è·ç¦»å¯è¿›é£Ÿ';
            hint = `é¢„è®¡å¯è¿›é£Ÿäº ${fmtTime(nextEat)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        } else {
            display = msToHMS(-left);
            label = 'å·²è¾¾åˆ°ç¦é£Ÿç›®æ ‡';
            hint = `ä½ å·²å¯è¿›é£Ÿï¼ˆä» ${fmtTime(nextEat)} èµ·ï¼‰`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        }
    }
    $('timerDisplay').innerText = display;
    $('timerLabel').innerText = label;
    $('timerHintText').innerText = hint;
    ring.style.strokeDashoffset = circum - (percent * circum);
};

/* ================= ç»Ÿè®¡ & å›¾è¡¨ ================= */
const isCompleted = (rec) => !!(rec && rec.startTime && rec.endTime);
const calcStats = () => {
    const keys = Object.keys(dayMap);
    const totalCompleted = keys.filter(k => isCompleted(dayMap[k])).length;
    let streak = 0;
    for (let i = 0; i < 365; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = dateKeyLocal(d);
        if (isCompleted(dayMap[k])) streak++;
        else break;
    }
    $('statStreak').innerText = streak;
    $('statTotal').innerText = totalCompleted;
    $('statRate').innerText = keys.length > 0 ? Math.round((totalCompleted / keys.length) * 100) + '%' : '0%';
};

const renderChart = () => {
    const container = $('weekChart');
    container.innerHTML = '';
    const daysCN = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = dateKeyLocal(d);
        const isToday = i === 0;
        const rec = dayMap[key];
        let filled = false, height = '6px';
        if (isToday) {
            if (state.endTime) { filled = true; height = '80%'; }
            else if (state.startTime) { height = '40%'; }
        } else if (rec) {
            if (isCompleted(rec)) { filled = true; height = '60%'; }
            else if (rec.startTime && !rec.endTime) { height = '30%'; }
        }
        const div = document.createElement('div');
        div.className = 'chart-bar-wrap';
        div.innerHTML = `
            <div class="chart-bar ${filled?'filled':''} ${isToday && !filled ? 'current':''}" style="height:${height}"></div>
            <span class="chart-day" style="${isToday?'color:var(--primary);font-weight:800':''}">${daysCN[d.getDay()]}</span>
        `;
        div.onclick = () => { toggleWeek(true); showDayDetail(key); };
        container.appendChild(div);
    }
};

const renderWeekList = () => {
    const list = $('weekList');
    if (!list) return;
    list.innerHTML = '';
    for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = dateKeyLocal(d);
        const rec = dayMap[key] || { dateKey: key };
        const ok = isCompleted(rec);
        const running = !!(rec.startTime && !rec.endTime);
        let pillCls = 'pill miss', pillText = 'æœªå®Œæˆ';
        if (ok) { pillCls = 'pill ok'; pillText = 'å·²å®Œæˆ'; }
        else if (running) { pillCls = 'pill run'; pillText = 'è¿›è¡Œä¸­'; }

        const hasExtra = (rec.extraMeals && rec.extraMeals.length > 0);
        const media = (rec.startMeal?.imageBase64 || rec.endMeal?.imageBase64 || (rec.startMeal?.note && rec.startMeal.note.trim()) || (rec.endMeal?.note && rec.endMeal.note.trim()));

        let sub = "æš‚æ— è®°å½•";
        if (ok) sub = `${fmtTime(rec.startTime)} â†’ ${fmtTime(rec.endTime)}`;
        else if (running) sub = `${fmtTime(rec.startTime)} Â· ç­‰å¾…æœ€åä¸€é¤`;

        const tags = [];
        if (media) tags.push("ğŸ“·");
        if (hasExtra) tags.push("âš ï¸");
        if (tags.length > 0) sub += ` ${tags.join(' ')}`;

        const el = document.createElement('div');
        el.className = 'week-item';
        el.innerHTML = `
            <div class="week-left">
                <div class="week-date">${key === state.dateKey ? 'ä»Šå¤©' : fmtDateCN(key)}</div>
                <div class="week-sub">${sub}</div>
            </div>
            <div class="${pillCls}">${pillText}</div>
        `;
        el.onclick = () => showDayDetail(key);
        list.appendChild(el);
    }
};

const showDayDetail = (key) => {
    $('weekListContainer').style.display = 'none';
    $('dayDetail').style.display = 'block';
    const rec = dayMap[key];
    $('detailTitle').innerText = (key === state.dateKey ? 'ä»Šå¤©' : fmtDateCN(key)) + ' Â· è¯¦æƒ…';
    $('d_extra_area').style.display = 'none';
    $('d_extra_list').innerHTML = '';
    if (!rec) {
        ['d_mode','d_start','d_end','d_eatwin','d_water','d_weight','d_note','d_s_time','d_e_time'].forEach(id => $(id).innerText = 'â€”');
        $('d_s_img').querySelector('img').src=''; $('d_s_img').style.display='none';
        $('d_e_img').querySelector('img').src=''; $('d_e_img').style.display='none';
        $('d_s_note').innerText = 'â€”'; $('d_e_note').innerText = 'â€”';
        $('d_sync').innerText = 'æ— è®°å½•';
        return;
    }
    const mode = rec.mode ?? 16;
    const eatH = MODES[mode]?.eat ?? 8;
    const fastH = MODES[mode]?.fast ?? 16;
    $('d_mode').innerText = `${mode}:${24-mode}`;
    $('d_start').innerText = rec.startTime ? fmtTime(rec.startTime) : 'â€”';
    $('d_end').innerText = rec.endTime ? fmtTime(rec.endTime) : 'â€”';
    $('d_eatwin').innerText = `è¿›é£Ÿ ${eatH}h Â· ç¦é£Ÿ ${fastH}h`;
    $('d_water').innerText = (rec.water ?? 0) + ' æ¯';
    $('d_weight').innerText = (rec.weight ?? 'â€”');
    $('d_note').innerText = (rec.note || 'â€”');

    if (rec.extraMeals && rec.extraMeals.length > 0) {
        $('d_extra_area').style.display = 'block';
        rec.extraMeals.forEach(meal => {
            const item = document.createElement('div');
            item.className = 'extra-meal-item';
            const hasImg = !!meal.imageBase64;
            item.innerHTML = `
                <div style="font-size:12px; font-weight:700;">ğŸ•’ ${fmtTime(meal.time)} ${hasImg ? 'ğŸ“·' : ''}</div>
                <div style="font-size:11px; color:var(--text-sec);">${meal.note || 'æ— å¤‡æ³¨'}</div>
            `;
            item.onclick = () => showSingleMealDetail('extra', meal);
            $('d_extra_list').appendChild(item);
        });
    }

    $('d_s_time').innerText = rec.startTime ? `æ‰“å¡ ${fmtTime(rec.startTime)}` : 'â€”';
    if(rec.startMeal?.imageBase64) {
        $('d_s_img').style.display='block';
        $('d_s_img').querySelector('img').src = base64ToDataUrl(rec.startMeal.imageBase64);
    } else { $('d_s_img').style.display='none'; }
    $('d_s_note').innerText = rec.startMeal?.note || 'â€”';

    $('d_e_time').innerText = rec.endTime ? `æ‰“å¡ ${fmtTime(rec.endTime)}` : 'â€”';
    if(rec.endMeal?.imageBase64) {
        $('d_e_img').style.display='block';
        $('d_e_img').querySelector('img').src = base64ToDataUrl(rec.endMeal.imageBase64);
    } else { $('d_e_img').style.display='none'; }
    $('d_e_note').innerText = rec.endMeal?.note || 'â€”';
    $('d_sync').innerText = `æœ€åæ›´æ–°ï¼š${new Date(rec.updatedAt || 0).toLocaleString()}`;
};

$('btnBackToWeek').onclick = () => {
    $('dayDetail').style.display = 'none';
    $('weekListContainer').style.display = 'block';
};

/* ================= æ‰“å¡ & å›¾ç‰‡å¼¹çª—é€»è¾‘ (Enhanced) ================= */
let pendingMealWhich = null;
let pendingFile = null;
let pendingPreviewURL = null;
let isEditing = false;

const resetUploadZone = () => {
    $('uploadZone').style.display = 'block';
    $('uploadZone').classList.remove('has-image');
    $('imgPreviewArea').style.display = 'none';
    $('mealImgPreview').querySelector('img').src = '';
    $('mealImgInput').value = '';
};

const showImagePreview = (src) => {
    $('uploadZone').style.display = 'none';
    $('imgPreviewArea').style.display = 'block';
    $('mealImgPreview').style.display = 'block';
    $('mealImgPreview').querySelector('img').src = src;
};

const openMealSheet = (which) => {
    pendingMealWhich = which;
    pendingFile = null;
    isEditing = false;
    if(pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = null;
    $('mealMsgInput').value = '';
    resetUploadZone();

    if (which === 'start') {
        $('mealSheetTitle').innerText = 'ğŸ³ ç¬¬ä¸€é¤æ‰“å¡';
        $('mealSheetSub').innerText = 'è®°å½•ä½ çš„ç¬¬ä¸€é¤';
    }
    else if (which === 'end') {
        $('mealSheetTitle').innerText = 'ğŸŒ™ æœ€åä¸€é¤æ‰“å¡';
        $('mealSheetSub').innerText = 'è®°å½•ä½ çš„æœ€åä¸€é¤';
    }
    else if (which === 'extra') {
        $('mealSheetTitle').innerText = 'ğŸ° è®°å½•é¢å¤–è¿›é£Ÿ';
        $('mealSheetSub').innerText = 'è®°å½•é¢å¤–çš„è¿›é£Ÿ';
    }
    toggleMeal(true);
};

const openEditMeal = (which, data) => {
    pendingMealWhich = which;
    pendingFile = null;
    isEditing = true;
    if(pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = null;
    $('mealMsgInput').value = data.note || '';

    if (data.imageBase64) {
        showImagePreview(base64ToDataUrl(data.imageBase64));
    } else {
        resetUploadZone();
    }

    $('mealSheetTitle').innerText = 'âœï¸ ä¿®æ”¹ / è¡¥å½•å›¾ç‰‡';
    $('mealSheetSub').innerText = 'ç¼–è¾‘æ‰“å¡è®°å½•';
    toggleMeal(true);
    toggleViewMeal(false);
};

// Enhanced upload zone interactions
const uploadZone = $('uploadZone');
uploadZone.onclick = () => $('mealImgInput').click();

// Drag and drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.type.startsWith('image/')) {
        handleImageFile(f);
    }
});

const handleImageFile = (f) => {
    pendingFile = f;
    if (pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = URL.createObjectURL(f);
    showImagePreview(pendingPreviewURL);
};

$('mealImgInput').addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    handleImageFile(f);
});

$('btnChangeImg').onclick = () => {
    $('mealImgInput').value = '';
    $('mealImgInput').click();
};

$('btnRemoveImg').onclick = () => {
    pendingFile = null;
    if (pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = null;
    resetUploadZone();
};

const confirmMealWithMedia = async () => {
    const which = pendingMealWhich;
    if (!which) return;
    btnLoading('mealConfirmBtn', true);
    try {
        ensureToday();
        if (!isEditing) {
            if (which === 'start') { state.startTime = Date.now(); state.endTime = null; }
            else if (which === 'end') { state.endTime = Date.now(); }
        }
        const msg = ($('mealMsgInput').value || '').trim();
        let b64 = "";
        if (pendingFile) {
            const res = await compressImageSmart(pendingFile);
            if (res.blob) b64 = await blobToBase64Raw(res.blob);
            if (!res.ok) {
                $('mealSizeWarn').style.display = 'block';
            }
        } else if (isEditing) {
            let oldData = {};
            if (which === 'start') oldData = state.startMeal || {};
            else if (which === 'end') oldData = state.endMeal || {};
            const previewVisible = $('imgPreviewArea').style.display !== 'none';
            if (previewVisible && !pendingFile) {
                b64 = oldData.imageBase64;
            }
        }

        const mealData = { note: msg, imageBase64: b64 };
        if (which === 'start') state.startMeal = mealData;
        else if (which === 'end') state.endMeal = mealData;
        else if (which === 'extra') {
            if (!isEditing) {
                if (!state.extraMeals) state.extraMeals = [];
                state.extraMeals.push({ time: Date.now(), ...mealData });
            }
        }

        state.updatedAt = Date.now();
        saveLocal();
        renderUI();
        toggleMeal(false);
        showToast(isEditing ? 'ä¿®æ”¹æˆåŠŸ' : 'è®°å½•æˆåŠŸ', 'âœ…');
        if(which === 'end' && !isEditing) fireConfetti();
        await cloudSync();
    } catch(e) {
        console.error(e);
        showToast('æ‰“å¡å¼‚å¸¸', 'âŒ', 'error');
    } finally {
        btnLoading('mealConfirmBtn', false);
    }
};

$('mealConfirmBtn').onclick = confirmMealWithMedia;
$('mealSkipBtn').onclick = async () => {
    pendingFile = null;
    $('mealMsgInput').value = '';
    await confirmMealWithMedia();
};

/* ================= Auth Logic ================= */
let isRegisterMode = false;
const updateAuthUI = () => {
    $('authTitle').innerText = isRegisterMode ? 'â˜ï¸ æ³¨å†Œæ–°è´¦å·' : 'â˜ï¸ ç™»å½•è´¦å·';
    $('btnAuthText').innerText = isRegisterMode ? 'ç«‹å³æ³¨å†Œ' : 'ç™»å½• / åŒæ­¥';
    $('tabLogin').classList.toggle('active', !isRegisterMode);
    $('tabRegister').classList.toggle('active', isRegisterMode);
};

$('tabLogin').onclick = () => { isRegisterMode = false; updateAuthUI(); };
$('tabRegister').onclick = () => { isRegisterMode = true; updateAuthUI(); };

$('btnAuthAction').onclick = async () => {
    const email = $('authEmail').value.trim();
    const pwd = $('authPwd').value.trim();
    if (!email || !pwd) return showToast('è¯·å¡«å†™å®Œæ•´', 'âš ï¸', 'error');
    if (pwd.length < 6) return showToast('å¯†ç éœ€6ä½ä»¥ä¸Š', 'âš ï¸', 'error');
    btnLoading('btnAuthAction', true);
    if (isRegisterMode) {
        const { error } = await supabase.auth.signUp({ email, password: pwd });
        if (error) showToast('æ³¨å†Œå¤±è´¥: ' + error.message, 'âŒ', 'error');
        else showToast('æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•', 'ğŸ‰');
    } else {
        const { error } = await supabase.auth.signInWithPassword({ email, password: pwd });
        if (error) showToast('ç™»å½•å¤±è´¥: ' + error.message, 'âŒ', 'error');
        else showToast('ç™»å½•æˆåŠŸ', 'âœ…');
    }
    btnLoading('btnAuthAction', false);
};

$('btnLogout').onclick = async () => {
    await supabase.auth.signOut();
    toggleAuth(false);
    showToast('å·²é€€å‡ºç™»å½•', 'ğŸ‘‹');
};

$('btnForcePull').onclick = async () => {
    if(!confirm('ç¡®å®šå¼ºåˆ¶ä»äº‘ç«¯è¦†ç›–æœ¬æœºæ•°æ®ï¼Ÿ')) return;
    await cloudPull(true);
};

supabase.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user ?? null;
    if (currentUser) {
        $('authForm').style.display = 'none';
        $('userPanel').style.display = 'block';
        $('userEmailDisplay').innerText = currentUser.email;
        cloudPull();
    } else {
        $('authForm').style.display = 'block';
        $('userPanel').style.display = 'none';
    }
});

/* ================= åº†ç¥é¡µé¢é€»è¾‘ ================= */
const handleLaunchSplash = () => {
    const splash = $('launchSplash');
    if(!splash) return;
    const KEY_LAUNCH_START = 'fasting_pro_launch_date_v2';
    const KEY_LAST_SEEN = 'fasting_pro_splash_last_seen_v2';
    const now = Date.now();
    let launchDate = localStorage.getItem(KEY_LAUNCH_START);
    if(!launchDate) {
        launchDate = now;
        localStorage.setItem(KEY_LAUNCH_START, launchDate);
    } else { launchDate = parseInt(launchDate); }
    const TWO_WEEKS = 14 * 24 * 60 * 60 * 1000;
    if (now - launchDate > TWO_WEEKS) return;
    const todayStr = new Date().toDateString();
    const lastSeen = localStorage.getItem(KEY_LAST_SEEN);
    if (lastSeen === todayStr) return;
    splash.classList.add('active');
    setTimeout(() => fireConfetti(), 300);
    localStorage.setItem(KEY_LAST_SEEN, todayStr);
    setTimeout(() => { splash.classList.remove('active'); }, 2500);
};

/* ================= Meal Detail View ================= */
const showSingleMealDetail = (which, extraData = null) => {
    let title = "", time = null, data = null;
    if (which === 'extra' && extraData) {
        title = 'ğŸ° é¢å¤–è¿›é£Ÿè¯¦æƒ…';
        time = extraData.time;
        data = extraData;
        $('btnEditMeal').style.display = 'none';
    } else {
        const isStart = which === 'start';
        title = isStart ? 'ğŸ³ ç¬¬ä¸€é¤è¯¦æƒ…' : 'ğŸŒ™ æœ€åä¸€é¤è¯¦æƒ…';
        time = isStart ? state.startTime : state.endTime;
        data = isStart ? (state.startMeal || {}) : (state.endMeal || {});
        $('btnEditMeal').style.display = 'block';
        $('btnEditMeal').onclick = () => openEditMeal(which, data);
    }
    if(!time) return;
    $('viewMealTitle').innerText = title;
    $('viewMealTimeStr').innerText = fmtTime(time);
    if(data.imageBase64) {
        $('viewMealImgTag').src = base64ToDataUrl(data.imageBase64);
        $('viewMealImgBox').style.display = 'block';
        $('viewMealNoImg').style.display = 'none';
    } else {
        $('viewMealImgBox').style.display = 'none';
        $('viewMealNoImg').style.display = 'block';
    }
    $('viewMealNoteStr').innerText = (data.note && data.note.trim()) ? data.note : 'æš‚æ— ç•™è¨€';
    toggleViewMeal(true);
};

/* ================= åˆå§‹åŒ– ================= */
const initTheme = () => {
    const saved = localStorage.getItem('theme');
    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (saved) document.documentElement.setAttribute('data-theme', saved);
    else if (sysDark) document.documentElement.setAttribute('data-theme', 'dark');
};

initTheme();
loadLocal();
renderUI();
handleLaunchSplash();

// æ¨¡å¼åˆ‡æ¢
$$('.tab').forEach(t => {
    t.onclick = () => {
        state.mode = parseInt(t.dataset.mode);
        saveLocal();
        renderUI();
        showToast(`å·²åˆ‡æ¢è‡³ ${state.mode}:${24-state.mode} æ¨¡å¼`);
    };
});

// äº‹ä»¶ç»‘å®š
$('themeBtn').onclick = () => {
    const curr = document.documentElement.getAttribute('data-theme');
    const next = curr === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
};
$('userBtn').onclick = () => toggleAuth(true);
$('authClose').onclick = () => toggleAuth(false);
$('weekBtn').onclick = () => { toggleWeek(true); renderWeekList(); };
$('weekClose').onclick = () => toggleWeek(false);
$('viewMealClose').onclick = () => toggleViewMeal(false);
$('viewMealOkBtn').onclick = () => toggleViewMeal(false);
$('mealClose').onclick = () => toggleMeal(false);
$('overlay').onclick = () => {
    toggleAuth(false); toggleWeek(false); toggleMeal(false); toggleViewMeal(false);
};

$('toggleMealMedia').onclick = () => { prefs.mealMediaEnabled = !prefs.mealMediaEnabled; saveLocal(); };
$('toggleMealMedia2').onclick = $('toggleMealMedia').onclick;

$('btnStartFast').onclick = () => {
    ensureToday();
    if(state.startTime) showSingleMealDetail('start');
    else if(prefs.mealMediaEnabled) openMealSheet('start');
    else { pendingMealWhich='start'; confirmMealWithMedia(); }
};
$('btnEndFast').onclick = () => {
    ensureToday();
    if(!state.startTime) return;
    if(state.endTime) showSingleMealDetail('end');
    else if(prefs.mealMediaEnabled) openMealSheet('end');
    else { pendingMealWhich='end'; confirmMealWithMedia(); }
};

$('btnExtraMeal').onclick = () => {
    ensureToday();
    openMealSheet('extra');
};

$('waterPlus').onclick = () => { ensureToday(); state.water++; saveLocal(); renderUI(); };
$('waterMinus').onclick = () => { ensureToday(); if(state.water>0)state.water--; saveLocal(); renderUI(); };
$('weightSaveBtn').onclick = () => { ensureToday(); state.weight=$('weightInput').value; saveLocal(); showToast('ä½“é‡å·²è®°å½•'); };
$('noteSaveBtn').onclick = () => { ensureToday(); state.note=$('noteInput').value.trim(); saveLocal(); showToast('èµ„æ–™å·²ä¿å­˜'); };
$('resetBtn').onclick = () => {
    if(confirm('é‡ç½®ä»Šæ—¥æ‰€æœ‰è®°å½•ï¼Ÿ')) {
        state.startTime=null; state.endTime=null; state.water=0; state.note="";
        state.startMeal={}; state.endMeal={}; state.extraMeals=[];
        saveLocal(); renderUI(); cloudSync();
        showToast('å·²é‡ç½®');
    }
};

setInterval(() => { ensureToday(); updateTimer(); }, 1000);
</script>
</body>
</html>
