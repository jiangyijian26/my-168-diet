<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#4F46E5" />
<meta name="description" content="å¥åº·é¥®é£Ÿ Pro 1.0 - ç§‘å­¦é¥®é£Ÿä¸é—´æ­‡æ€§æ–­é£ŸåŠ©æ‰‹" />
<title>å¥åº·é¥®é£Ÿ Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #6366f1;
    --primary-dark: #4338ca;
    --primary-glow: rgba(99, 102, 241, 0.4);
    --success: #10b981;
    --success-glow: rgba(16, 185, 129, 0.3);
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-body: #f8fafc;
    --bg-card: rgba(255, 255, 255, 0.75);
    --bg-glass-panel: rgba(255, 255, 255, 0.9);
    --text-main: #0f172a;
    --text-sec: #64748b;
    --text-ter: #94a3b8;
    --border: rgba(148, 163, 184, 0.2);
    --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
    --radius-xl: 28px;
    --radius-lg: 20px;
    --radius-md: 14px;
    --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
}
[data-theme="dark"] {
    --primary: #818cf8;
    --primary-dark: #6366f1;
    --primary-glow: rgba(129, 140, 248, 0.3);
    --bg-body: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-glass-panel: rgba(15, 23, 42, 0.9);
    --text-main: #f1f5f9;
    --text-sec: #94a3b8;
    --text-ter: #475569;
    --border: rgba(255, 255, 255, 0.08);
    --shadow-lg: 0 20px 40px -10px rgba(0,0,0,0.6);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
html, body { height: 100%; overflow-x: hidden; }
body {
    margin: 0; padding: 0;
    font-family: var(--font-main);
    background: var(--bg-body);
    color: var(--text-main);
    transition: background 0.4s ease, color 0.4s ease;
    background-image:
        radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15), transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.1), transparent 50%);
    background-attachment: fixed;
}
.container {
    max-width: 460px; margin: 0 auto;
    padding: calc(16px + env(safe-area-inset-top)) 20px calc(40px + env(safe-area-inset-bottom));
    min-height: 100vh;
    display: flex; flex-direction: column;
}
.topbar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 24px; padding-top: 10px;
}
.brand h1 { margin: 0; font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
.brand-badge {
    font-size: 11px; color: #fff; background: var(--primary);
    padding: 3px 8px; border-radius: 100px; margin-left: 8px;
    vertical-align: middle; font-weight: 700; box-shadow: 0 2px 8px var(--primary-glow);
}
.nav-actions { display: flex; gap: 12px; }
.icon-btn {
    width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-main);
    display: grid; place-items: center; cursor: pointer; font-size: 18px;
    transition: 0.2s var(--ease-elastic); backdrop-filter: blur(10px);
}
.icon-btn:active { transform: scale(0.9); }
.card {
    background: var(--bg-card);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    padding: 24px; margin-bottom: 20px;
    position: relative; overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.mode-tabs {
    display: flex; background: rgba(0,0,0,0.04);
    padding: 5px; border-radius: 18px; margin-bottom: 24px;
    position: relative; overflow: hidden;
}
[data-theme="dark"] .mode-tabs { background: rgba(255,255,255,0.08); }
.tab {
    flex: 1; text-align: center; padding: 12px 0; font-size: 13px; font-weight: 700;
    color: var(--text-sec); border-radius: 14px; cursor: pointer; z-index: 2;
    transition: 0.3s;
}
.tab.active {
    background: var(--bg-card); color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.timer-section { position: relative; margin: 10px 0 30px; text-align: center; }
.timer-wrap {
    width: 260px; height: 260px; margin: 0 auto; position: relative;
    filter: drop-shadow(0 10px 30px var(--primary-glow));
}
.timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; overflow: visible; }
.timer-track { fill: none; stroke: var(--border); stroke-width: 12; stroke-linecap: round; }
.timer-progress {
    fill: none; stroke: url(#gradientMain); stroke-width: 12; stroke-linecap: round;
    stroke-dasharray: 722; stroke-dashoffset: 722;
    transition: stroke-dashoffset 1s linear;
}
.timer-content {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.timer-val {
    font-size: 44px; font-weight: 800; font-variant-numeric: tabular-nums;
    letter-spacing: -2px; line-height: 1; margin-bottom: 6px;
    background: linear-gradient(135deg, var(--text-main), var(--text-sec));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.timer-sub { font-size: 14px; font-weight: 600; color: var(--text-sec); margin-bottom: 10px; }
.timer-hint {
    font-size: 12px; color: var(--text-ter); font-weight: 600;
    background: rgba(0,0,0,0.04);
    padding: 8px 12px; border-radius: 999px;
    display: inline-flex; gap: 8px; align-items: center;
    border: 1px solid var(--border);
}
[data-theme="dark"] .timer-hint { background: rgba(255,255,255,0.06); }
.status-badge {
    padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(0,0,0,0.05); color: var(--text-sec);
    transition: 0.3s;
    margin-bottom: 12px;
}
.status-badge.fasting { background: var(--success-glow); color: var(--success); }
.status-badge.eating { background: var(--primary-glow); color: var(--primary); }
.status-badge.warn { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
.pulse-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
.meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
.meal-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 18px;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    transition: 0.3s; cursor: pointer; position: relative;
    min-height: 110px;
}
.meal-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
.meal-card.done { border-color: var(--success); opacity: 0.96; }
.meal-card:active { transform: scale(0.96); }
.meal-emoji { font-size: 32px; margin-bottom: 10px; transition: 0.3s var(--ease-elastic); }
.meal-card:hover .meal-emoji { transform: scale(1.2) rotate(10deg); }
.meal-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; display:flex; align-items:center; gap:8px; justify-content:center; }
.meal-time { font-size: 12px; color: var(--text-ter); font-weight: 600; }
.mini-badge {
    font-size: 10px; font-weight: 900;
    padding: 4px 8px; border-radius: 999px;
    background: rgba(0,0,0,0.05);
    border: 1px solid var(--border);
    color: var(--text-sec);
}
[data-theme="dark"] .mini-badge { background: rgba(255,255,255,0.06); }
.deadline-chip {
    margin-top: 10px;
    font-size: 11px;
    font-weight: 700;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.04);
    color: var(--text-sec);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}
[data-theme="dark"] .deadline-chip { background: rgba(255,255,255,0.06); }
.deadline-chip.over { color: var(--danger); border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.08); }
.deadline-chip.ok { color: var(--success); border-color: rgba(16,185,129,0.25); background: rgba(16,185,129,0.08); }
.metrics-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; margin-bottom: 20px; }
.mini-control {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(0,0,0,0.03); border-radius: 12px; padding: 6px; margin-top: 10px;
}
[data-theme="dark"] .mini-control { background: rgba(255,255,255,0.06); }
.circle-btn {
    width: 32px; height: 32px; border-radius: 10px; border: none;
    background: #fff; color: var(--text-main); font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;
}
[data-theme="dark"] .circle-btn { background: #334155; color: var(--text-main); }
.weight-inp {
    width: 70px; background: transparent; border: none; text-align: center;
    font-weight: 800; font-size: 16px; color: var(--text-main);
}
.stats-card { padding-bottom: 16px; }
.stats-header { display: flex; justify-content: space-around; margin-bottom: 18px; }
.stat-box { text-align: center; }
.stat-num { font-size: 20px; font-weight: 800; display: block; }
.stat-lbl { font-size: 11px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-top: 4px; }
.chart-container {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
    height: 100px; align-items: end; padding: 0 10px;
}
.chart-bar-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
.chart-bar {
    width: 8px; border-radius: 10px; background: var(--border);
    transition: height 1s var(--ease-elastic), background 0.3s;
    min-height: 6px; position: relative;
}
.chart-bar.filled { background: var(--success); box-shadow: 0 0 10px var(--success-glow); }
.chart-bar.current { background: var(--primary); }
.chart-day { font-size: 11px; color: var(--text-ter); font-weight: 700; }
.overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    z-index: 99; opacity: 0; pointer-events: none; transition: 0.4s;
}
.overlay.visible { opacity: 1; pointer-events: auto; }
.bottom-sheet {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--bg-glass-panel); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border-radius: 30px 30px 0 0; padding: 26px 20px calc(26px + env(safe-area-inset-bottom));
    z-index: 100; transform: translateY(110%); transition: 0.5s var(--ease-elastic);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
    max-width: 600px; margin: 0 auto;
    max-height: min(82vh, 760px);
    overflow: auto;
}
.bottom-sheet.visible { transform: translateY(0); }
.sheet-head { display:flex; justify-content:space-between; align-items:center; gap: 12px; margin-bottom: 18px; }
.sheet-head h2 { margin:0; font-size: 20px; letter-spacing: -0.3px; }
.sheet-close {
    background:none; border:none; font-size: 26px; color: var(--text-ter); cursor:pointer;
    width: 40px; height: 40px; border-radius: 12px;
    display: grid; place-items: center;
}
.sheet-close:active { transform: scale(0.96); }
.input-box {
    width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border);
    background: rgba(0,0,0,0.03); font-size: 16px; color: var(--text-main);
    margin-bottom: 12px; transition: 0.3s;
}
[data-theme="dark"] .input-box { background: rgba(255,255,255,0.06); }
.input-box:focus { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }
textarea.input-box { resize:none; }
.btn {
    width: 100%; padding: 16px; border: none; border-radius: 16px;
    font-size: 16px; font-weight: 800; cursor: pointer;
    display: flex; justify-content: center; align-items: center; gap: 8px;
    transition: 0.2s; position: relative;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--primary); color: white; box-shadow: 0 8px 20px var(--primary-glow); }
.btn-primary:hover { background: var(--primary-dark); }
.btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-main); }
.btn-text { background: transparent; color: var(--text-sec); font-size: 14px; margin-top: 10px; font-weight: 700; }
.toast {
    position: fixed; top: calc(20px + env(safe-area-inset-top)); left: 50%;
    transform: translateX(-50%) scale(0.9); opacity: 0; pointer-events: none;
    background: rgba(15, 23, 42, 0.9); color: white;
    padding: 12px 18px; border-radius: 50px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex; align-items: center; gap: 10px; z-index: 999;
    transition: 0.4s var(--ease-elastic); font-weight: 700;
    max-width: calc(100vw - 24px);
}
.toast.visible { transform: translateX(-50%) scale(1); opacity: 1; }
.spinner {
    width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
}
.btn.loading .spinner { display: block; }
.btn.loading span { display: none; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 200; }

/* è®¤è¯åˆ‡æ¢ Tabs */
.auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.auth-tab {
    flex: 1; text-align: center; padding: 10px; border-radius: 12px;
    font-weight: 700; color: var(--text-sec); cursor: pointer;
    background: rgba(0,0,0,0.03); border: 1px solid transparent;
}
[data-theme="dark"] .auth-tab { background: rgba(255,255,255,0.05); }
.auth-tab.active {
    background: var(--bg-card); color: var(--primary);
    border-color: var(--primary); box-shadow: 0 2px 8px var(--primary-glow);
}

/* å…¶ä»–å¤ç”¨æ ·å¼ */
.week-list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
.week-item {
    border: 1px solid var(--border);
    background: var(--bg-card);
    border-radius: 16px;
    padding: 12px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: 0.2s;
}
.week-item:active { transform: scale(0.98); }
.week-left { display: flex; flex-direction: column; gap: 4px; }
.week-date { font-weight: 800; font-size: 13px; }
.week-sub { font-size: 12px; color: var(--text-sec); font-weight: 700; }
.pill {
    font-size: 11px;
    font-weight: 800;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--text-sec);
    background: rgba(0,0,0,0.03);
    white-space: nowrap;
}
[data-theme="dark"] .pill { background: rgba(255,255,255,0.06); }
.pill.ok { color: var(--success); border-color: rgba(16,185,129,0.25); background: rgba(16,185,129,0.08); }
.pill.run { color: var(--primary); border-color: rgba(99,102,241,0.25); background: rgba(99,102,241,0.08); }
.pill.miss { color: var(--danger); border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.08); }
.detail-box {
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.02);
    border-radius: 18px;
    padding: 14px;
    margin-top: 12px;
}
[data-theme="dark"] .detail-box { background: rgba(255,255,255,0.04); }
.detail-row { display:flex; justify-content: space-between; gap: 10px; padding: 8px 0; border-bottom: 1px dashed var(--border); font-weight: 700; }
.detail-row:last-child { border-bottom: none; }
.detail-k { color: var(--text-sec); font-size: 12px; }
.detail-v { color: var(--text-main); font-size: 12px; text-align: right; }
.upload-card {
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.02);
    border-radius: 18px;
    padding: 14px;
    display:flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 12px;
}
[data-theme="dark"] .upload-card { background: rgba(255,255,255,0.04); }
.upload-row { display:flex; justify-content: space-between; align-items:center; gap: 10px; }
.upload-h { font-weight: 900; font-size: 13px; }
.upload-sub { font-size: 11px; color: var(--text-ter); font-weight: 700; line-height: 1.35; }
.switch {
    width: 50px; height: 30px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.06);
    position: relative;
    cursor: pointer;
    flex: none;
    transition: 0.25s;
}
[data-theme="dark"] .switch { background: rgba(255,255,255,0.08); }
.switch::after {
    content:""; width: 24px; height: 24px; border-radius: 50%; background: #fff;
    position:absolute; top: 2.5px; left: 3px; box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    transition: 0.25s var(--ease-elastic);
}
[data-theme="dark"] .switch::after { background: #e2e8f0; }
.switch.on { background: rgba(99,102,241,0.25); border-color: rgba(99,102,241,0.35); }
.switch.on::after { left: 22px; background: var(--primary); }
.img-preview {
    width: 100%; border-radius: 16px; border: 1px solid var(--border);
    overflow: hidden; background: rgba(0,0,0,0.03); display:none;
}
[data-theme="dark"] .img-preview { background: rgba(255,255,255,0.06); }
.img-preview img { width: 100%; height: auto; display:block; }
.two-col { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.small-btn { padding: 12px; border-radius: 14px; font-weight: 900; font-size: 14px; }
.meal-media-grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 10px; }
.meal-media-box {
    border: 1px solid var(--border); border-radius: 16px; background: rgba(0,0,0,0.02); padding: 12px;
}
[data-theme="dark"] .meal-media-box { background: rgba(255,255,255,0.04); }
.meal-media-head { display:flex; justify-content: space-between; align-items:center; gap: 10px; margin-bottom: 10px; }
.meal-media-head .t { font-weight: 900; font-size: 13px; }
.meal-media-head .s { font-size: 11px; color: var(--text-ter); font-weight: 800; }
.meal-media-img {
    width: 100%; border-radius: 14px; border: 1px solid var(--border); overflow:hidden;
    margin-bottom: 10px; display:none;
}
.meal-media-img img { width:100%; height:auto; display:block; }
.meal-media-note { font-size: 12px; color: var(--text-sec); font-weight: 700; line-height:1.5; white-space: pre-wrap; }
/* å¯åŠ¨å± */
.launch-splash {
    position: fixed; inset: 0; z-index: 2000;
    background: linear-gradient(135deg, #4f46e5, #ec4899);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #fff; text-align: center;
    opacity: 0; pointer-events: none; transition: opacity 0.6s ease;
}
.launch-splash.active { opacity: 1; pointer-events: auto; }
.launch-title { font-size: 32px; font-weight: 900; margin-bottom: 10px; animation: bounceIn 0.8s; }
.launch-sub { font-size: 16px; font-weight: 600; opacity: 0.9; animation: fadeIn 1.2s; }
@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="launch-splash" id="launchSplash">
<div style="font-size:60px; margin-bottom:10px;"> ğŸ‰ </div>
<div class="launch-title">å¥åº·é¥®é£Ÿ Pro 1.0</div>
<div class="launch-sub">å…¨æ–°å‡çº§ Â· æé€Ÿä½“éªŒ Â· Supabase é©±åŠ¨</div>
</div>
<div class="container">
<div class="topbar">
<div class="brand">
<h1>å¥åº·é¥®é£Ÿ <span style="font-weight:300">Pro</span><span class="brand-badge">Supa</span></h1>
</div>
<div class="nav-actions">
<button class="icon-btn" id="themeBtn" title="ä¸»é¢˜"> ğŸŒ“ </button>
<button class="icon-btn" id="userBtn" title="äº‘åŒæ­¥"> ğŸ‘¤ </button>
</div>
</div>
<div class="mode-tabs">
<div class="tab" data-mode="12">12:12<br><span style="font-size:10px; font-weight:600; opacity:0.65">æ–°æ‰‹</span></div>
<div class="tab" data-mode="14">14:10<br><span style="font-size:10px; font-weight:600; opacity:0.65">æ—¥å¸¸</span></div>
<div class="tab active" data-mode="16">16:8<br><span style="font-size:10px; font-weight:600; opacity:0.65">ç‡ƒè„‚</span></div>
<div class="tab" data-mode="18">18:6<br><span style="font-size:10px; font-weight:600; opacity:0.65">è¿›é˜¶</span></div>
</div>
<div class="card timer-section">
<div class="timer-wrap">
<svg class="timer-svg" viewBox="0 0 240 240">
<defs>
<linearGradient id="gradientMain" x1="0%" y1="0%" x2="100%" y2="100%">
<stop offset="0%" stop-color="#6366f1" />
<stop offset="100%" stop-color="#a855f7" />
</linearGradient>
<linearGradient id="gradientSuccess" x1="0%" y1="0%" x2="100%" y2="100%">
<stop offset="0%" stop-color="#10b981" />
<stop offset="100%" stop-color="#34d399" />
</linearGradient>
</defs>
<circle class="timer-track" cx="120" cy="120" r="115"></circle>
<circle class="timer-progress" id="progressRing" cx="120" cy="120" r="115"></circle>
</svg>
<div class="timer-content">
<div class="timer-val" id="timerDisplay">--:--</div>
<div class="timer-sub" id="timerLabel">å‡†å¤‡å¼€å§‹</div>
<div class="status-badge" id="statusBadge">
<div class="pulse-dot"></div>
<span id="statusText">ç©ºè…¹æœŸ</span>
</div>
<div class="timer-hint" id="timerHint" style="display:none;"> â±ï¸  <span id="timerHintText">â€”</span></div>
</div>
</div>
</div>
<div class="meal-grid">
<div class="meal-card" id="btnStartFast">
<div class="meal-emoji"> ğŸ³ </div>
<div class="meal-title">
ç¬¬ä¸€é¤ <span class="mini-badge" id="mediaBadgeStart" style="display:none;"> ğŸ“· </span>
</div>
<div class="meal-time" id="startLabel">ç‚¹å‡»å¼€å§‹æ‰“å¡</div>
</div>
<div class="meal-card" id="btnEndFast">
<div class="meal-emoji"> ğŸŒ™ </div>
<div class="meal-title">
æœ€åä¸€é¤ <span class="mini-badge" id="mediaBadgeEnd" style="display:none;"> ğŸ“· </span>
</div>
<div class="meal-time" id="endLabel">ç­‰å¾…å¼€å§‹</div>
<div class="deadline-chip" id="deadlineChip" style="display:none;"> â³  æœ€æ™šå¯è¿›é£Ÿè‡³ï¼š--:--</div>
</div>
</div>
<div class="card" style="padding: 18px 18px; margin-top: -6px;">
<div style="font-size:12px; color:var(--text-sec); font-weight:800; margin-bottom:10px;"> ğŸ—‚ï¸  ä»Šæ—¥èµ„æ–™ / å¤‡æ³¨ï¼ˆå¯åŒæ­¥ï¼‰</div>
<textarea id="noteInput" class="input-box" rows="3" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©åƒäº†ä»€ä¹ˆã€è®­ç»ƒ/ä½œæ¯ã€èº«ä½“æ„Ÿå—â€¦ï¼ˆçº¯æ–‡æœ¬ï¼‰"></textarea>
<button class="btn btn-outline" id="noteSaveBtn"><span>ä¿å­˜èµ„æ–™</span><div class="spinner"></div></button>
<div style="font-size:11px; color:var(--text-ter); margin-top:8px; font-weight:700;">æç¤ºï¼šç™»å½•åä¼šè‡ªåŠ¨äº‘ç«¯åŒæ­¥ï¼ˆè·¨è®¾å¤‡å®æ—¶ä¸€è‡´ï¼‰ã€‚</div>
</div>
<div class="metrics-row">
<div class="card" style="margin:0; display:flex; flex-direction:column; justify-content:center;">
<div style="font-size:12px; color:var(--text-sec); font-weight:800; margin-bottom:8px;"> ğŸ’§  é¥®æ°´ (æ¯)</div>
<div class="mini-control">
<button class="circle-btn" id="waterMinus">-</button>
<span style="font-weight:900; font-size:20px; color:var(--primary);" id="waterCount">0</span>
<button class="circle-btn" id="waterPlus" style="color:var(--primary);">+</button>
</div>
</div>
<div class="card" style="margin:0; display:flex; flex-direction:column; justify-content:center;">
<div style="font-size:12px; color:var(--text-sec); font-weight:800; margin-bottom:8px;"> âš–ï¸  ä½“é‡ (kg)</div>
<div class="mini-control">
<input type="number" class="weight-inp" id="weightInput" placeholder="0.0" step="0.1">
<button class="circle-btn" id="weightSaveBtn" style="width:auto; padding:0 12px; font-size:12px;">ä¿å­˜</button>
</div>
</div>
</div>
<div class="card stats-card">
<div class="stats-header">
<div class="stat-box">
<span class="stat-num" id="statStreak">0</span>
<span class="stat-lbl"> ğŸ”¥  è¿ç»­å¤©æ•°</span>
</div>
<div class="stat-box">
<span class="stat-num" id="statTotal">0</span>
<span class="stat-lbl"> ğŸ“…  ç´¯è®¡æ‰“å¡</span>
</div>
<div class="stat-box">
<span class="stat-num" id="statRate">0%</span>
<span class="stat-lbl"> ğŸ“ˆ  å®Œæˆç‡</span>
</div>
</div>
<div style="height:1px; background:var(--border); margin-bottom:16px;"></div>
<div class="chart-container" id="weekChart"></div>
</div>
<div class="card" style="padding: 18px 18px; margin-top: -6px;">
<div style="display:flex; justify-content:space-between; align-items:center; gap: 12px;">
<div>
<div style="font-size:12px; color:var(--text-sec); font-weight:900;"> ğŸ“š  è¿‘ä¸€å‘¨è®°å½•</div>
<div style="font-size:11px; color:var(--text-ter); font-weight:700; margin-top:4px;">å«æ‰“å¡ã€é¥®æ°´ã€ä½“é‡ã€èµ„æ–™å¤‡æ³¨ã€é¤å›¾ä¸ç•™è¨€ï¼ˆç™»å½•åå¯è·¨è®¾å¤‡å®æ—¶åŒæ­¥ï¼‰</div>
</div>
<button class="icon-btn" id="weekBtn" title="æŸ¥çœ‹è¿‘ä¸€å‘¨" style="width:46px; height:46px;"> ğŸ—“ï¸ </button>
</div>
</div>
<div style="margin-top:auto; text-align:center;">
<button class="btn-text" id="resetBtn">é‡ç½®ä»Šæ—¥çŠ¶æ€</button>
</div>
</div>
<div class="overlay" id="overlay"></div>

<div class="bottom-sheet" id="authSheet">
    <div class="sheet-head">
        <h2 id="authTitle"> â˜ï¸  ç™»å½•è´¦å·</h2>
        <button class="sheet-close" id="authClose">&times;</button>
    </div>

    <div class="auth-tabs">
        <div class="auth-tab active" id="tabLogin">ç™»å½•</div>
        <div class="auth-tab" id="tabRegister">æ³¨å†Œ</div>
    </div>

    <div id="authForm">
        <input type="email" class="input-box" id="authEmail" placeholder="ç”µå­é‚®ç®±">
        <input type="password" class="input-box" id="authPwd" placeholder="å¯†ç  (6ä½ä»¥ä¸Š)">
        <button class="btn btn-primary" id="btnAuthAction" style="margin-bottom:12px;">
            <span id="btnAuthText">ç™»å½• / åŒæ­¥</span><div class="spinner"></div>
        </button>
        
        <div style="text-align:center; font-size:12px; color:var(--text-ter); margin-top:10px;">
            å›½å†…ç›´è¿ç‰ˆ (Powered by Supabase)
        </div>

        <div class="upload-card" style="margin-top:14px;">
            <div class="upload-row">
                <div>
                    <div class="upload-h"> ğŸ“·  ä¸Šä¼ å›¾ç‰‡ & ç•™è¨€</div>
                    <div class="upload-sub">å¯é€‰ã€‚ç™»å½•åæ•°æ®å°†ä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“ã€‚</div>
                </div>
                <div class="switch" id="toggleMealMedia"></div>
            </div>
            <div class="upload-sub" id="toggleHint">æœªç™»å½•ï¼šä»…æœ¬æœºç”Ÿæ•ˆï¼›ç™»å½•åï¼šå¤šç«¯åŒæ­¥ã€‚</div>
        </div>
    </div>

    <div id="userPanel" style="display:none; text-align:center; padding:10px 0 0;">
        <div style="font-size:56px; margin-bottom:10px; animation: pulse 3s infinite;"> ğŸ‰ </div>
        <h3 id="userEmailDisplay" style="margin:0 0 6px;"></h3>
        <p style="color:var(--text-sec); font-size:14px; margin: 0 0 18px; font-weight:700;">æ•°æ®å·²å®æ—¶å¤‡ä»½è‡³ Supabase Cloud</p>
        <div class="upload-card" style="text-align:left;">
            <div class="upload-row">
                <div>
                    <div class="upload-h"> ğŸ“·  ä¸Šä¼ å›¾ç‰‡ & ç•™è¨€</div>
                    <div class="upload-sub">å·²ç™»å½•ï¼šè®¾ç½®å·²åŒæ­¥ã€‚</div>
                </div>
                <div class="switch" id="toggleMealMedia2"></div>
            </div>
        </div>
        <button class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); margin-bottom: 10px;" id="btnLogout">é€€å‡ºç™»å½•</button>
        <button class="btn btn-outline" id="btnForcePull">ä»äº‘ç«¯å¼ºåˆ¶æ‹‰å–</button>
    </div>
</div>

<div class="bottom-sheet" id="weekSheet">
<div class="sheet-head">
<h2> ğŸ—“ï¸  è¿‘ä¸€å‘¨æ‰“å¡</h2>
<button class="sheet-close" id="weekClose">&times;</button>
</div>
<div style="font-size:12px; color:var(--text-sec); font-weight:800; margin-bottom:10px;">
ç‚¹å‡»æŸä¸€å¤©æŸ¥çœ‹è¯¦æƒ…ï¼ˆå«é¤å›¾ã€ç•™è¨€ä¸èµ„æ–™å¤‡æ³¨ï¼‰
</div>
<div class="week-list" id="weekList"></div>
<div id="dayDetail" class="detail-box" style="display:none;">
<div style="font-weight:900; margin-bottom:8px; font-size:13px;" id="detailTitle">â€”</div>
<div class="detail-row"><div class="detail-k">æ¨¡å¼</div><div class="detail-v" id="d_mode">â€”</div></div>
<div class="detail-row"><div class="detail-k">ç¬¬ä¸€é¤</div><div class="detail-v" id="d_start">â€”</div></div>
<div class="detail-row"><div class="detail-k">æœ€åä¸€é¤</div><div class="detail-v" id="d_end">â€”</div></div>
<div class="detail-row"><div class="detail-k">è¿›é£Ÿçª—å£</div><div class="detail-v" id="d_eatwin">â€”</div></div>
<div class="detail-row"><div class="detail-k">é¥®æ°´</div><div class="detail-v" id="d_water">â€”</div></div>
<div class="detail-row"><div class="detail-k">ä½“é‡</div><div class="detail-v" id="d_weight">â€”</div></div>
<div class="detail-row"><div class="detail-k">èµ„æ–™å¤‡æ³¨</div><div class="detail-v" id="d_note">â€”</div></div>
<div class="meal-media-grid">
<div class="meal-media-box">
<div class="meal-media-head">
<div class="t"> ğŸ³  ç¬¬ä¸€é¤ï¼šå›¾ç‰‡/ç•™è¨€</div>
<div class="s" id="d_s_time">â€”</div>
</div>
<div class="meal-media-img" id="d_s_img"><img alt="ç¬¬ä¸€é¤å›¾ç‰‡"></div>
<div class="meal-media-note" id="d_s_note">â€”</div>
</div>
<div class="meal-media-box">
<div class="meal-media-head">
<div class="t"> ğŸŒ™  æœ€åä¸€é¤ï¼šå›¾ç‰‡/ç•™è¨€</div>
<div class="s" id="d_e_time">â€”</div>
</div>
<div class="meal-media-img" id="d_e_img"><img alt="æœ€åä¸€é¤å›¾ç‰‡"></div>
<div class="meal-media-note" id="d_e_note">â€”</div>
</div>
</div>
<div style="margin-top:10px; font-size:11px; color:var(--text-ter); font-weight:700;" id="d_sync">â€”</div>
</div>
</div>
<div class="bottom-sheet" id="viewMealSheet">
<div class="sheet-head">
<h2 id="viewMealTitle"> ğŸ³  æ‰“å¡è¯¦æƒ…</h2>
<button class="sheet-close" id="viewMealClose">&times;</button>
</div>

<div class="upload-card">
<div class="upload-row">
<div class="upload-h"> ğŸ•’  æ‰“å¡æ—¶é—´</div>
<div class="upload-sub" id="viewMealTimeStr" style="font-size:14px; font-weight:700; color:var(--primary);">--:--</div>
</div>
</div>
<div class="meal-media-box" style="margin-bottom:12px;">
<div class="meal-media-head">
<div class="t"> ğŸ“·  å›¾ç‰‡è®°å½•</div>
</div>
<div class="meal-media-img" id="viewMealImgBox" style="display:block;">
<img id="viewMealImgTag" alt="å›¾ç‰‡" />
</div>
<div class="upload-sub" id="viewMealNoImg" style="display:none; text-align:center; padding:10px;">æš‚æ— å›¾ç‰‡</div>
</div>
<div class="upload-card">
<div class="upload-h" style="margin-bottom:6px;"> ğŸ’¬  ç•™è¨€å¤‡æ³¨</div>
<div class="meal-media-note" id="viewMealNoteStr">æš‚æ— ç•™è¨€</div>
</div>
<button class="btn btn-outline" id="viewMealOkBtn">å…³é—­</button>
</div>
<div class="bottom-sheet" id="mealSheet">
<div class="sheet-head">
<h2 id="mealSheetTitle"> ğŸ³  æ‰“å¡</h2>
<button class="sheet-close" id="mealClose">&times;</button>
</div>
<div class="upload-card">
<div class="upload-h" id="mealSheetSub">â€”</div>
<div class="upload-sub" id="mealSheetHint">å¯é€‰ï¼šæ·»åŠ é£Ÿç‰©å›¾ç‰‡ä¸ç•™è¨€ã€‚ç™»å½•åä¼šåŒæ­¥åˆ°äº‘ç«¯ã€‚</div>
</div>
<div class="upload-card" id="mealMediaArea">
<div class="upload-row">
<div>
<div class="upload-h"> ğŸ“·  é£Ÿç‰©å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</div>
<div class="upload-sub">ä¼šè‡ªåŠ¨å‹ç¼©å¹¶ä»¥ Base64 å†™å…¥æ•°æ®åº“ã€‚</div>
</div>
<button class="btn btn-outline small-btn" id="btnPickImg" style="width:auto;"><span>é€‰æ‹©å›¾ç‰‡</span><div class="spinner"></div></button>
</div>
<input id="mealImgInput" type="file" accept="image/*" capture="environment" style="display:none;">
<div class="img-preview" id="mealImgPreview"><img alt="é¢„è§ˆ"></div>
<div class="two-col">
<button class="btn btn-outline small-btn" id="btnRemoveImg"><span>ç§»é™¤å›¾ç‰‡</span><div class="spinner"></div></button>
<button class="btn btn-outline small-btn" id="btnCompressInfo"><span>å‹ç¼©è¯´æ˜</span><div class="spinner"></div></button>
</div>
<div class="upload-h"> ğŸ’¬  ç•™è¨€ï¼ˆå¯é€‰ï¼‰</div>
<textarea id="mealMsgInput" class="input-box" rows="3" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©åƒäº†é¸¡èƒ¸/æ²™æ‹‰ã€å¿ƒæƒ…ã€è®­ç»ƒå¼ºåº¦â€¦ï¼ˆçº¯æ–‡æœ¬ï¼‰"></textarea>
<div class="upload-sub" id="mealCloudWarn" style="display:none;">
âš ï¸  æœªç™»å½•ï¼šå›¾ç‰‡/ç•™è¨€ä¼šå…ˆä¿å­˜åœ¨æœ¬æœºï¼›ç™»å½•åæ‰ä¼šåŒæ­¥åˆ°äº‘ç«¯ã€‚
</div>
<div class="upload-sub" id="mealSizeWarn" style="display:none;">
âš ï¸  å›¾ç‰‡è¿‡å¤§ï¼šå·²å°½åŠ›å‹ç¼©ï¼Œä»å¯èƒ½å› æ•°æ®åº“é™åˆ¶æ— æ³•ä¿å­˜å›¾ç‰‡ã€‚
</div>
</div>
<button class="btn btn-primary" id="mealConfirmBtn"><span>ç¡®è®¤æ‰“å¡</span><div class="spinner"></div></button>
<button class="btn btn-outline" id="mealSkipBtn" style="margin-top:10px;"><span>ä¸æ·»åŠ å›¾ç‰‡/ç•™è¨€ï¼Œç›´æ¥æ‰“å¡</span><div class="spinner"></div></button>
</div>
<div class="toast" id="toast">
<span id="toastIcon"> âœ… </span>
<span id="toastMsg">æ“ä½œæˆåŠŸ</span>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

/* ================= é…ç½®åŒº ================= */
// å¡«å…¥ä½ çš„ Supabase URL å’Œ Key
const supabaseUrl = 'https://mjssiorvprbeuvdnbxkw.supabase.co'
const supabaseKey = 'sb_publishable_0nfL1jDXViLVQUffJfKSFA_vSdCXrco'
const supabase = createClient(supabaseUrl, supabaseKey)

const MODES = {
    12: { eat: 12, fast: 12 },
    14: { eat: 10, fast: 14 },
    16: { eat: 8, fast: 16 },
    18: { eat: 6, fast: 18 }
};

/* ================= å·¥å…·å‡½æ•° ================= */
const STORAGE_KEY = 'fasting_pro_v5_state';
const PREF_KEY = 'fasting_pro_v5_prefs';
const HISTORY_KEY = 'fasting_pro_v5_history'; // æ–°å¢ï¼šæœ¬åœ°å†å²å­˜å‚¨
const TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const pad2 = n => String(n).padStart(2, '0');
const dateKeyLocal = (d = new Date()) => {
    const y = d.getFullYear();
    const m = pad2(d.getMonth() + 1);
    const day = pad2(d.getDate());
    return `${y}-${m}-${day}`;
};
const fmtTime = (ms) => {
    if (!ms) return null;
    const d = new Date(ms);
    return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
};
const fmtDateCN = (key) => {
    const [y, m, d] = key.split('-');
    return `${y}/${m}/${d}`;
};
const msToHMS = (ms) => {
    const sign = ms < 0 ? '-' : '';
    const x = Math.abs(ms);
    const h = Math.floor(x / 3600000);
    const m = Math.floor((x % 3600000) / 60000);
    const s = Math.floor((x % 60000) / 1000);
    return `${sign}${h}:${pad2(m)}:${pad2(s)}`;
};
const showToast = (msg, icon = ' âœ… ', type = 'normal') => {
    const t = $('toast');
    $('toastMsg').innerText = msg;
    $('toastIcon').innerText = icon;
    t.style.background = type === 'error'
        ? 'var(--danger)'
        : (document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255,255,255,0.92)' : 'rgba(15, 23, 42, 0.92)');
    t.style.color = type === 'error'
        ? '#fff'
        : (document.documentElement.getAttribute('data-theme') === 'dark' ? '#000' : '#fff');
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 2500);
};
const fireConfetti = () => {
    const canvas = $('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const particles = [];
    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444'];
    for(let i=0; i<120; i++) {
        particles.push({
            x: canvas.width / 2, y: canvas.height / 2,
            vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15 - 8,
            color: colors[Math.floor(Math.random() * colors.length)],
            life: 150
        });
    }
    const animate = () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let active = false;
        particles.forEach(p => {
            if(p.life > 0) {
                p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life--;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 7, 7);
                active = true;
            }
        });
        if(active) requestAnimationFrame(animate);
        else ctx.clearRect(0,0,canvas.width,canvas.height);
    };
    animate();
};
const btnLoading = (id, loading) => {
    const btn = $(id);
    if (!btn) return;
    if(loading) { btn.classList.add('loading'); btn.disabled = true; }
    else { btn.classList.remove('loading'); btn.disabled = false; }
};
const toggleSheet = (id, show) => {
    const s = $(id), o = $('overlay');
    if (show) { s.classList.add('visible'); o.classList.add('visible'); }
    else { s.classList.remove('visible'); o.classList.remove('visible'); }
};
const toggleAuth = (show) => toggleSheet('authSheet', show);
const toggleWeek = (show) => toggleSheet('weekSheet', show);
const toggleMeal = (show) => toggleSheet('mealSheet', show);
const toggleViewMeal = (show) => toggleSheet('viewMealSheet', show);

/* ================= æœ¬åœ°æ•°æ®ç®¡ç† ================= */
let prefs = { mealMediaEnabled: false };
let dayMap = {}; // å­˜å‚¨æ‰€æœ‰å†å²æ•°æ® Key: dateKey, Value: DayRecord
let state = {    // ä»Šæ—¥çŠ¶æ€ (å¿«æ·è®¿é—®ï¼ŒæŒ‡å‘ dayMap[today])
    dateKey: dateKeyLocal(),
    mode: 16,
    startTime: null,
    endTime: null,
    water: 0,
    weight: null,
    note: "",
    startMeal: { note: "", imageBase64: "" },
    endMeal: { note: "", imageBase64: "" },
    updatedAt: 0
};
let currentUser = null;

// åŠ è½½æœ¬åœ°å­˜å‚¨
const loadLocal = () => {
    try {
        // Prefs
        const rawPrefs = localStorage.getItem(PREF_KEY);
        if (rawPrefs) prefs = { ...prefs, ...JSON.parse(rawPrefs) };
        
        // History (DayMap)
        const rawHistory = localStorage.getItem(HISTORY_KEY);
        if (rawHistory) dayMap = JSON.parse(rawHistory);
        
        // State (Today)
        const rawState = localStorage.getItem(STORAGE_KEY);
        if (rawState) state = { ...state, ...JSON.parse(rawState) };
    } catch(e) { console.error("Local Load Error", e); }
};

// ä¿å­˜æœ¬åœ°å­˜å‚¨
const saveLocal = () => {
    localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    
    // æ›´æ–° dayMap ä¸­çš„ä»Šå¤©
    dayMap[state.dateKey] = { ...state };
    localStorage.setItem(HISTORY_KEY, JSON.stringify(dayMap));
    
    syncToggleUI();
};

const ensureToday = () => {
    const today = dateKeyLocal();
    if (state.dateKey !== today) {
        state = {
            dateKey: today,
            mode: state.mode,
            startTime: null,
            endTime: null,
            water: 0,
            weight: state.weight || null,
            note: "",
            startMeal: { note:"", imageBase64:"" },
            endMeal: { note:"", imageBase64:"" },
            updatedAt: Date.now()
        };
        saveLocal();
    }
};

/* ================= Supabase äº‘åŒæ­¥ ================= */
// å®Œæ•´æ•°æ®ç»“æ„ï¼š { user_id: '...', data: { days: { ... }, prefs: { ... } } }

const cloudSync = async () => {
    if (!currentUser) return;
    
    const fullPayload = {
        days: dayMap,
        prefs: prefs,
        lastSync: Date.now()
    };

    const { error } = await supabase
        .from('diet_logs')
        .upsert({ 
            user_id: currentUser.id, 
            data: fullPayload 
        }, { onConflict: 'user_id' });

    if (error) {
        console.error("Cloud Sync Failed", error);
        // showToast('äº‘åŒæ­¥å¤±è´¥', 'âš ï¸', 'error'); // é™é»˜å¤±è´¥ä¸æ‰“æ‰°
    }
};

const cloudPull = async (force = false) => {
    if (!currentUser) return;

    const { data, error } = await supabase
        .from('diet_logs')
        .select('data')
        .eq('user_id', currentUser.id)
        .single();

    if (data && data.data) {
        const cloudData = data.data;
        
        // ç®€å•ç­–ç•¥ï¼šäº‘ç«¯å¦‚æœæœ‰æ•°æ®ï¼Œä¸”æœ¬åœ°æ²¡æœ‰æˆ–è€…å¼ºåˆ¶æ‹‰å–ï¼Œå°±è¦†ç›–
        // è¿™é‡Œçš„åˆå¹¶ç­–ç•¥å¯ä»¥æ›´å¤æ‚ï¼Œç®€å•èµ·è§æˆ‘ä»¬åšåˆå¹¶
        if (cloudData.days) dayMap = { ...dayMap, ...cloudData.days };
        if (cloudData.prefs) prefs = { ...prefs, ...cloudData.prefs };
        
        // åˆ·æ–°ä»Šæ—¥ State
        const today = dateKeyLocal();
        if (dayMap[today]) {
            // åªæœ‰å½“äº‘ç«¯çš„æ—¶é—´æ›´æ–°æ—¶æ‰è¦†ç›–ï¼Œé˜²æ­¢æœ¬åœ°åˆšæ“ä½œè¢«è¦†ç›–
            if (force || (dayMap[today].updatedAt || 0) > (state.updatedAt || 0)) {
                state = dayMap[today];
            }
        }
        
        saveLocal();
        renderUI();
        if(force) showToast('å·²ä»äº‘ç«¯æ¢å¤æ•°æ®', 'â˜ï¸');
    }
};

/* ================= å›¾ç‰‡å¤„ç† ================= */
const fileToImage = async (file) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.src = url;
    try {
        await new Promise((res, rej) => {
            img.onload = () => res();
            img.onerror = () => rej(new Error("image load failed"));
        });
        return { img, url };
    } catch (e) {
        URL.revokeObjectURL(url);
        throw e;
    }
};
const canvasToBlob = (canvas, quality) =>
    new Promise((res) => canvas.toBlob(res, 'image/jpeg', quality));
const compressImageSmart = async (file, opts = {}) => {
    const maxSideStart = opts.maxSideStart ?? 1024;
    const minSide = opts.minSide ?? 600;
    const qStart = opts.qStart ?? 0.7;
    const qMin = opts.qMin ?? 0.4;
    const targetBytes = opts.targetBytes ?? (180 * 1024);
    const { img, url } = await fileToImage(file);
    try {
        const w0 = img.naturalWidth || img.width;
        const h0 = img.naturalHeight || img.height;
        let maxSide = maxSideStart;
        let quality = qStart;
        let best = null;
        for (let attempt = 0; attempt < 8; attempt++) {
            let nw = w0, nh = h0;
            const scale = Math.min(1, maxSide / Math.max(w0, h0));
            nw = Math.round(w0 * scale);
            nh = Math.round(h0 * scale);
            const canvas = document.createElement('canvas');
            canvas.width = nw;
            canvas.height = nh;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, nw, nh);
            const blob = await canvasToBlob(canvas, quality);
            if (!blob) throw new Error("toBlob failed");
            if (!best || blob.size < best.size) best = blob;
            if (blob.size <= targetBytes) {
                return { blob, ok: true, size: blob.size };
            }
            if (quality > qMin) {
                quality = Math.max(qMin, quality - 0.1);
            } else if (maxSide > minSide) {
                maxSide = Math.max(minSide, Math.round(maxSide * 0.8));
                quality = qStart;
            } else {
                break;
            }
        }
        return { blob: best, ok: false, size: best?.size ?? 0 };
    } finally {
        URL.revokeObjectURL(url);
    }
};
const blobToBase64Raw = (blob) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const s = String(reader.result || "");
            const idx = s.indexOf(',');
            resolve(idx >= 0 ? s.slice(idx + 1) : s);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
};
const base64ToDataUrl = (b64) => b64 ? `data:image/jpeg;base64,${b64}` : "";

/* ================= UI æ¸²æŸ“ ================= */
const syncToggleUI = () => {
    const on = !!prefs.mealMediaEnabled;
    const a = $('toggleMealMedia');
    const b = $('toggleMealMedia2');
    if (a) a.classList.toggle('on', on);
    if (b) b.classList.toggle('on', on);
};

const renderUI = () => {
    ensureToday();
    $$('.tab').forEach(t => t.classList.toggle('active', +t.dataset.mode === state.mode));
    $('waterCount').innerText = state.water;
    if (state.weight !== null && state.weight !== undefined && state.weight !== '') $('weightInput').value = state.weight;
    $('noteInput').value = state.note || '';
    
    const bStart = $('btnStartFast');
    const bEnd = $('btnEndFast');
    const badge = $('statusBadge');
    const ring = $('progressRing');
    
    bStart.className = 'meal-card';
    bEnd.className = 'meal-card';
    ring.style.stroke = 'url(#gradientMain)';
    
    // æ›´æ–° Deadline Chip
    const chip = $('deadlineChip');
    if(state.startTime) {
         const eatMs = MODES[state.mode].eat * 3600000;
         const deadline = state.startTime + eatMs;
         const now = Date.now();
         const endStr = fmtTime(deadline);
         chip.style.display = 'inline-flex';
         chip.innerText = ` â³  æœ€æ™šå¯è¿›é£Ÿè‡³ï¼š${endStr}`;
         chip.classList.remove('ok', 'over');
         if (deadline - now >= 0) chip.classList.add('ok');
         else chip.classList.add('over');
    } else {
        chip.style.display = 'none';
    }

    // æ›´æ–° Media Badges
    const sBadge = $('mediaBadgeStart');
    const eBadge = $('mediaBadgeEnd');
    const hasS = !!(state.startMeal?.imageBase64 || (state.startMeal?.note && state.startMeal.note.trim()));
    const hasE = !!(state.endMeal?.imageBase64 || (state.endMeal?.note && state.endMeal.note.trim()));
    sBadge.style.display = hasS ? 'inline-block' : 'none';
    eBadge.style.display = hasE ? 'inline-block' : 'none';

    const startStr = fmtTime(state.startTime);
    const endStr = fmtTime(state.endTime);

    if (!state.startTime) {
        $('statusText').innerText = 'ç©ºè…¹æœŸ';
        badge.className = 'status-badge fasting';
        $('timerHint').style.display = 'none';
        bStart.classList.add('active');
        $('startLabel').innerText = 'ç‚¹å‡»å¼€å§‹æ‰“å¡';
        $('endLabel').innerText = 'ç­‰å¾…å¼€å§‹';
    } else if (!state.endTime) {
        $('statusText').innerText = 'è¿›é£Ÿçª—å£';
        badge.className = 'status-badge eating';
        ring.style.stroke = 'url(#gradientSuccess)';
        bStart.classList.add('done');
        $('startLabel').innerText = 'å¼€å§‹äº ' + startStr;
        bEnd.classList.add('active');
        $('endLabel').innerText = 'ç‚¹å‡»æœ€åä¸€é¤æ‰“å¡';
    } else {
        $('statusText').innerText = 'ç¦é£ŸæœŸ';
        badge.className = 'status-badge fasting';
        bStart.classList.add('done');
        $('startLabel').innerText = startStr;
        bEnd.classList.add('done');
        $('endLabel').innerText = endStr;
    }
    calcStats();
    renderChart();
    renderWeekList();
    updateTimer();
};

const updateTimer = () => {
    const ring = $('progressRing');
    const circum = 722;
    if (!state.startTime) {
        ring.style.strokeDashoffset = circum;
        $('timerDisplay').innerText = '--:--';
        $('timerLabel').innerText = 'ç­‰å¾…æ‰“å¡';
        $('timerHint').style.display = 'none';
        return;
    }
    const now = Date.now();
    let percent = 0;
    let display = "";
    let label = "";
    let hint = "";
    
    if (!state.endTime) {
        const eatDur = MODES[state.mode].eat * 3600000;
        const end = state.startTime + eatDur;
        const left = end - now;
        const passed = now - state.startTime;
        if (left > 0) {
            percent = Math.min(1, Math.max(0, passed / eatDur));
            display = msToHMS(left);
            label = 'è·ç¦»çª—å£å…³é—­';
            hint = `æœ€æ™šå¯è¿›é£Ÿè‡³ ${fmtTime(end)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        } else {
            percent = 1;
            display = "00:00:00";
            label = "å·²è¶…æ—¶";
            hint = `å·²è¶…è¿‡çª—å£å…³é—­æ—¶é—´ ${fmtTime(end)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.add('warn');
        }
    } else {
        const fastDur = MODES[state.mode].fast * 3600000;
        const nextEat = state.endTime + fastDur;
        const left = nextEat - now;
        const passed = now - state.endTime;
        percent = Math.min(1, Math.max(0, passed / fastDur));
        if (left > 0) {
            display = msToHMS(left);
            label = 'è·ç¦»å¯è¿›é£Ÿ';
            hint = `é¢„è®¡å¯è¿›é£Ÿäº ${fmtTime(nextEat)}`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        } else {
            display = msToHMS(-left);
            label = 'å·²è¾¾åˆ°ç¦é£Ÿç›®æ ‡';
            hint = `ä½ å·²å¯è¿›é£Ÿï¼ˆä» ${fmtTime(nextEat)} èµ·ï¼‰`;
            $('timerHint').style.display = 'inline-flex';
            $('statusBadge').classList.remove('warn');
        }
    }
    $('timerDisplay').innerText = display;
    $('timerLabel').innerText = label;
    $('timerHintText').innerText = hint;
    ring.style.strokeDashoffset = circum - (percent * circum);
};

/* ================= ç»Ÿè®¡ & å›¾è¡¨ ================= */
const isCompleted = (rec) => !!(rec && rec.startTime && rec.endTime);
const calcStats = () => {
    // ç®€å•ç»Ÿè®¡é€»è¾‘ï¼ŒåŸºäº dayMap
    const keys = Object.keys(dayMap);
    const totalCompleted = keys.filter(k => isCompleted(dayMap[k])).length;
    let streak = 0;
    for (let i = 0; i < 365; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = dateKeyLocal(d);
        if (isCompleted(dayMap[k])) streak++;
        else break;
    }
    $('statStreak').innerText = streak;
    $('statTotal').innerText = totalCompleted;
    $('statRate').innerText = keys.length > 0 ? Math.round((totalCompleted / keys.length) * 100) + '%' : '0%';
};

const renderChart = () => {
    const container = $('weekChart');
    container.innerHTML = '';
    const daysCN = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = dateKeyLocal(d);
        const isToday = i === 0;
        const rec = dayMap[key];
        let filled = false;
        let height = '6px';
        if (isToday) {
            if (state.endTime) { filled = true; height = '80%'; }
            else if (state.startTime) { height = '40%'; }
        } else if (rec) {
            if (isCompleted(rec)) { filled = true; height = '60%'; }
            else if (rec.startTime && !rec.endTime) { height = '30%'; }
        }
        const div = document.createElement('div');
        div.className = 'chart-bar-wrap';
        div.innerHTML = `
            <div class="chart-bar ${filled?'filled':''} ${isToday && !filled ? 'current':''}" style="height:${height}"></div>
            <span class="chart-day" style="${isToday?'color:var(--primary)':''}">${daysCN[d.getDay()]}</span>
        `;
        div.onclick = () => { toggleWeek(true); showDayDetail(key); };
        container.appendChild(div);
    }
};

const renderWeekList = () => {
    const list = $('weekList');
    if (!list) return;
    list.innerHTML = '';
    for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = dateKeyLocal(d);
        const rec = dayMap[key] || { dateKey: key };
        const ok = isCompleted(rec);
        const running = !!(rec.startTime && !rec.endTime);
        let pillCls = 'pill miss';
        let pillText = 'æœªå®Œæˆ';
        if (ok) { pillCls = 'pill ok'; pillText = 'å·²å®Œæˆ'; }
        else if (running) { pillCls = 'pill run'; pillText = 'è¿›è¡Œä¸­'; }
        
        const media = (rec.startMeal?.imageBase64 || rec.endMeal?.imageBase64 || (rec.startMeal?.note && rec.startMeal.note.trim()) || (rec.endMeal?.note && rec.endMeal.note.trim()));
        const mediaTag = media ? ' Â· å«é¤å›¾/ç•™è¨€' : '';
        const sub = ok
            ? `ç¬¬ä¸€é¤ ${fmtTime(rec.startTime)} Â· æœ€åä¸€é¤ ${fmtTime(rec.endTime)}${mediaTag}`
            : running
            ? `ç¬¬ä¸€é¤ ${fmtTime(rec.startTime)} Â· ç­‰å¾…æœ€åä¸€é¤${mediaTag}`
            : (rec.note && rec.note.trim() ? `æœ‰èµ„æ–™å¤‡æ³¨${mediaTag}` : (media ? `æœ‰é¤å›¾/ç•™è¨€` : `æš‚æ— è®°å½•`));
            
        const el = document.createElement('div');
        el.className = 'week-item';
        el.innerHTML = `
            <div class="week-left">
                <div class="week-date">${key === state.dateKey ? 'ä»Šå¤©' : fmtDateCN(key)}</div>
                <div class="week-sub">${sub}</div>
            </div>
            <div class="${pillCls}">${pillText}</div>
        `;
        el.onclick = () => showDayDetail(key);
        list.appendChild(el);
    }
};

const showDayDetail = (key) => {
    const box = $('dayDetail');
    box.style.display = 'block';
    const rec = dayMap[key];
    $('detailTitle').innerText = (key === state.dateKey ? 'ä»Šå¤©' : fmtDateCN(key)) + ' Â· è¯¦æƒ…';
    
    if (!rec) {
        // ... æ¸…ç©ºæ˜¾ç¤º (ç•¥å¾®ç®€åŒ–ä»£ç ï¼Œé€»è¾‘åŒå‰)
        $('d_mode').innerText = 'â€”';
        $('d_start').innerText = 'â€”';
        $('d_end').innerText = 'â€”';
        $('d_eatwin').innerText = 'â€”';
        $('d_water').innerText = 'â€”';
        $('d_weight').innerText = 'â€”';
        $('d_note').innerText = 'â€”';
        $('d_s_time').innerText = 'â€”';
        $('d_e_time').innerText = 'â€”';
        $('d_s_img').querySelector('img').src=''; $('d_s_img').style.display='none';
        $('d_e_img').querySelector('img').src=''; $('d_e_img').style.display='none';
        $('d_s_note').innerText = 'â€”';
        $('d_e_note').innerText = 'â€”';
        $('d_sync').innerText = 'æ— è®°å½•';
        return;
    }
    // ... å¡«å……æ•°æ®
    const mode = rec.mode ?? 16;
    const eatH = MODES[mode]?.eat ?? 8;
    const fastH = MODES[mode]?.fast ?? 16;
    $('d_mode').innerText = `${mode}:${24-mode}`;
    $('d_start').innerText = rec.startTime ? fmtTime(rec.startTime) : 'â€”';
    $('d_end').innerText = rec.endTime ? fmtTime(rec.endTime) : 'â€”';
    $('d_eatwin').innerText = `è¿›é£Ÿ ${eatH}h Â· ç¦é£Ÿ ${fastH}h`;
    $('d_water').innerText = (rec.water ?? 0) + ' æ¯';
    $('d_weight').innerText = (rec.weight ?? 'â€”');
    $('d_note').innerText = (rec.note || 'â€”');
    
    $('d_s_time').innerText = rec.startTime ? `æ‰“å¡ ${fmtTime(rec.startTime)}` : 'â€”';
    if(rec.startMeal?.imageBase64) {
        $('d_s_img').style.display='block';
        $('d_s_img').querySelector('img').src = base64ToDataUrl(rec.startMeal.imageBase64);
    } else { $('d_s_img').style.display='none'; }
    $('d_s_note').innerText = rec.startMeal?.note || 'â€”';

    $('d_e_time').innerText = rec.endTime ? `æ‰“å¡ ${fmtTime(rec.endTime)}` : 'â€”';
    if(rec.endMeal?.imageBase64) {
        $('d_e_img').style.display='block';
        $('d_e_img').querySelector('img').src = base64ToDataUrl(rec.endMeal.imageBase64);
    } else { $('d_e_img').style.display='none'; }
    $('d_e_note').innerText = rec.endMeal?.note || 'â€”';
    
    $('d_sync').innerText = `æœ€åæ›´æ–°ï¼š${new Date(rec.updatedAt || 0).toLocaleString()}`;
};

/* ================= æ‰“å¡ & å›¾ç‰‡å¼¹çª—é€»è¾‘ (ä¿ç•™åŸé€»è¾‘) ================= */
let pendingMealWhich = null;
let pendingFile = null;
let pendingPreviewURL = null;

const openMealSheet = (which) => {
    pendingMealWhich = which;
    pendingFile = null;
    if(pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = null;
    $('mealMsgInput').value = '';
    $('mealImgPreview').style.display = 'none';
    const isStart = which === 'start';
    $('mealSheetTitle').innerText = isStart ? ' ğŸ³  ç¬¬ä¸€é¤æ‰“å¡' : ' ğŸŒ™  æœ€åä¸€é¤æ‰“å¡';
    toggleMeal(true);
};

$('btnPickImg').onclick = () => $('mealImgInput').click();
$('mealImgInput').addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    pendingFile = f;
    if (pendingPreviewURL) URL.revokeObjectURL(pendingPreviewURL);
    pendingPreviewURL = URL.createObjectURL(f);
    $('mealImgPreview').querySelector('img').src = pendingPreviewURL;
    $('mealImgPreview').style.display = 'block';
});
$('btnRemoveImg').onclick = () => {
    pendingFile = null;
    $('mealImgPreview').style.display = 'none';
};

const confirmMealWithMedia = async () => {
    const which = pendingMealWhich;
    if (!which) return;
    btnLoading('mealConfirmBtn', true);
    try {
        ensureToday();
        if (which === 'start') {
            state.startTime = Date.now();
            state.endTime = null;
        } else {
            state.endTime = Date.now();
        }
        
        const msg = ($('mealMsgInput').value || '').trim();
        let b64 = "";
        
        if (pendingFile) {
            const res = await compressImageSmart(pendingFile);
            if (res.blob) b64 = await blobToBase64Raw(res.blob);
        }
        
        const mealData = { note: msg, imageBase64: b64 };
        if (which === 'start') state.startMeal = mealData;
        else state.endMeal = mealData;
        
        state.updatedAt = Date.now();
        saveLocal();
        renderUI();
        toggleMeal(false);
        showToast('æ‰“å¡å®Œæˆ', 'âœ…');
        if(which === 'end') fireConfetti();
        
        await cloudSync();
        
    } catch(e) {
        console.error(e);
        showToast('æ‰“å¡å¼‚å¸¸', 'âŒ', 'error');
    } finally {
        btnLoading('mealConfirmBtn', false);
    }
};

$('mealConfirmBtn').onclick = confirmMealWithMedia;
$('mealSkipBtn').onclick = async () => {
    pendingFile = null;
    $('mealMsgInput').value = '';
    await confirmMealWithMedia();
};

/* ================= Auth Logic (é‡æ„éƒ¨åˆ†) ================= */
// åˆ‡æ¢ Auth Mode
let isRegisterMode = false;
const updateAuthUI = () => {
    const title = isRegisterMode ? ' â˜ï¸  æ³¨å†Œæ–°è´¦å·' : ' â˜ï¸  ç™»å½•è´¦å·';
    const btnText = isRegisterMode ? 'ç«‹å³æ³¨å†Œ' : 'ç™»å½• / åŒæ­¥';
    $('authTitle').innerText = title;
    $('btnAuthText').innerText = btnText;
    
    $('tabLogin').classList.toggle('active', !isRegisterMode);
    $('tabRegister').classList.toggle('active', isRegisterMode);
};

$('tabLogin').onclick = () => { isRegisterMode = false; updateAuthUI(); };
$('tabRegister').onclick = () => { isRegisterMode = true; updateAuthUI(); };

$('btnAuthAction').onclick = async () => {
    const email = $('authEmail').value.trim();
    const pwd = $('authPwd').value.trim();
    if (!email || !pwd) return showToast('è¯·å¡«å†™å®Œæ•´', 'âš ï¸', 'error');
    if (pwd.length < 6) return showToast('å¯†ç éœ€6ä½ä»¥ä¸Š', 'âš ï¸', 'error');

    btnLoading('btnAuthAction', true);
    
    if (isRegisterMode) {
        // æ³¨å†Œ
        const { error } = await supabase.auth.signUp({ email, password: pwd });
        if (error) showToast('æ³¨å†Œå¤±è´¥: ' + error.message, 'âŒ', 'error');
        else showToast('æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•', 'ğŸ‰');
    } else {
        // ç™»å½•
        const { error } = await supabase.auth.signInWithPassword({ email, password: pwd });
        if (error) showToast('ç™»å½•å¤±è´¥: ' + error.message, 'âŒ', 'error');
        else showToast('ç™»å½•æˆåŠŸ', 'âœ…');
    }
    btnLoading('btnAuthAction', false);
};

$('btnLogout').onclick = async () => {
    await supabase.auth.signOut();
    toggleAuth(false);
    showToast('å·²é€€å‡ºç™»å½•', 'ğŸ‘‹');
};

$('btnForcePull').onclick = async () => {
    if(!confirm('ç¡®å®šå¼ºåˆ¶ä»äº‘ç«¯è¦†ç›–æœ¬æœºæ•°æ®ï¼Ÿ')) return;
    await cloudPull(true);
};

// ç›‘å¬ Auth çŠ¶æ€
supabase.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user ?? null;
    if (currentUser) {
        $('authForm').style.display = 'none';
        $('userPanel').style.display = 'block';
        $('userEmailDisplay').innerText = currentUser.email;
        // ç™»å½•åè‡ªåŠ¨æ‹‰å–æ•°æ®
        cloudPull();
    } else {
        $('authForm').style.display = 'block';
        $('userPanel').style.display = 'none';
    }
});

// åˆå§‹åŒ–
const initTheme = () => {
    const saved = localStorage.getItem('theme');
    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (saved) document.documentElement.setAttribute('data-theme', saved);
    else if (sysDark) document.documentElement.setAttribute('data-theme', 'dark');
};
initTheme();
loadLocal();
renderUI();

$('themeBtn').onclick = () => {
    const curr = document.documentElement.getAttribute('data-theme');
    const next = curr === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
};
$('userBtn').onclick = () => toggleAuth(true);
$('authClose').onclick = () => toggleAuth(false);
$('weekBtn').onclick = () => { toggleWeek(true); renderWeekList(); };
$('weekClose').onclick = () => toggleWeek(false);
$('viewMealClose').onclick = () => toggleViewMeal(false);
$('viewMealOkBtn').onclick = () => toggleViewMeal(false);
$('mealClose').onclick = () => toggleMeal(false);

$('toggleMealMedia').onclick = () => { prefs.mealMediaEnabled = !prefs.mealMediaEnabled; saveLocal(); };
$('toggleMealMedia2').onclick = $('toggleMealMedia').onclick;

$('btnStartFast').onclick = () => {
    ensureToday();
    if(state.startTime) showSingleMealDetail('start'); // å·²æ‰“å¡çœ‹è¯¦æƒ…
    else if(prefs.mealMediaEnabled) openMealSheet('start');
    else { pendingMealWhich='start'; confirmMealWithMedia(); }
};
$('btnEndFast').onclick = () => {
    ensureToday();
    if(!state.startTime) return;
    if(state.endTime) showSingleMealDetail('end');
    else if(prefs.mealMediaEnabled) openMealSheet('end');
    else { pendingMealWhich='end'; confirmMealWithMedia(); }
};
// è¯¦æƒ…æŸ¥çœ‹é€»è¾‘ (ç®€åŒ–ç‰ˆ)
const showSingleMealDetail = (which) => {
    const isStart = which === 'start';
    const time = isStart ? state.startTime : state.endTime;
    const data = isStart ? (state.startMeal || {}) : (state.endMeal || {});
    if(!time) return;
    $('viewMealTitle').innerText = isStart ? ' ğŸ³  ç¬¬ä¸€é¤è¯¦æƒ…' : ' ğŸŒ™  æœ€åä¸€é¤è¯¦æƒ…';
    $('viewMealTimeStr').innerText = fmtTime(time);
    if(data.imageBase64) {
        $('viewMealImgTag').src = base64ToDataUrl(data.imageBase64);
        $('viewMealImgBox').style.display = 'block';
        $('viewMealNoImg').style.display = 'none';
    } else {
        $('viewMealImgBox').style.display = 'none';
        $('viewMealNoImg').style.display = 'block';
    }
    $('viewMealNoteStr').innerText = (data.note && data.note.trim()) ? data.note : 'æš‚æ— ç•™è¨€';
    toggleViewMeal(true);
};

// é¥®æ°´/ä½“é‡/å¤‡æ³¨
$('waterPlus').onclick = () => { ensureToday(); state.water++; saveLocal(); renderUI(); };
$('waterMinus').onclick = () => { ensureToday(); if(state.water>0)state.water--; saveLocal(); renderUI(); };
$('weightSaveBtn').onclick = () => { ensureToday(); state.weight=$('weightInput').value; saveLocal(); showToast('ä½“é‡å·²è®°å½•'); };
$('noteSaveBtn').onclick = () => { ensureToday(); state.note=$('noteInput').value.trim(); saveLocal(); showToast('èµ„æ–™å·²ä¿å­˜'); };
$('resetBtn').onclick = () => {
    if(confirm('é‡ç½®ä»Šæ—¥æ‰€æœ‰è®°å½•ï¼Ÿ')) {
        state.startTime=null; state.endTime=null; state.water=0; state.note=""; state.startMeal={}; state.endMeal={};
        saveLocal(); renderUI(); cloudSync();
        showToast('å·²é‡ç½®');
    }
};

setInterval(() => { ensureToday(); updateTimer(); }, 1000);
</script>
</body>
</html>