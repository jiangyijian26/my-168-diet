<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16+8 è½»æ–­é£ŸåŠ©æ‰‹</title>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-color: #1d1d1f;
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --secondary-bg: #e5e5ea;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #f5f5f7;
            --secondary-bg: #2c2c2e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 420px;
        }

        .card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        h2 { margin-top: 0; font-size: 20px; text-align: center; }

        input {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #d1d1d6;
            border-radius: 12px;
            box-sizing: border-box;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        button.secondary { background-color: var(--secondary-bg); color: var(--text-color); }
        button.danger { background-color: var(--danger-color); }
        button.success { background-color: var(--success-color); }

        /* çŠ¶æ€æ˜¾ç¤ºå¤§å­— */
        .timer-box {
            text-align: center;
            padding: 20px 0;
        }
        .timer-text {
            font-size: 48px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin: 10px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--secondary-bg);
            font-size: 14px;
            font-weight: 500;
        }

        /* å†å²è®°å½• */
        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--secondary-bg);
            font-size: 14px;
        }
        .history-item:last-child { border-bottom: none; }

        /* ç”¨æˆ·æ  */
        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }
        .btn-small {
            width: auto;
            padding: 6px 12px;
            margin: 0 0 0 8px;
            font-size: 12px;
        }

        #app { display: none; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="authForm" class="card">
        <h2>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ 16+8 åŠ©æ‰‹</h2>
        <input type="email" id="email" placeholder="é‚®ç®±åœ°å€">
        <input type="password" id="password" placeholder="è®¾ç½®å¯†ç ">
        <button onclick="window.login()">ç™»å½•</button>
        <button class="secondary" onclick="window.register()">æ³¨å†Œè´¦å·</button>
        <p style="text-align:center; font-size:12px; color:#999; margin-top:15px;">
            å›½å†…ç›´è¿ç‰ˆ (Powered by Supabase)
        </p>
    </div>

    <div id="app">
        <div class="user-bar">
            <span id="userEmailDisplay">æœªç™»å½•</span>
            <div>
                <button class="btn-small secondary" onclick="window.syncToCloud()">â˜ï¸ åŒæ­¥</button>
                <button class="btn-small danger" onclick="window.logout()">é€€å‡º</button>
            </div>
        </div>

        <div class="card">
            <div class="timer-box">
                <div id="statusBadge" class="status-badge">åŠ è½½ä¸­...</div>
                <div id="timerDisplay" class="timer-text">--:--:--</div>
                <div id="targetTime" style="color:#888; font-size:14px;">ç›®æ ‡æ—¶é—´: --:--</div>
            </div>
            <button id="actionBtn" onclick="window.toggleEating()">å¼€å§‹è¿›é£Ÿ</button>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:16px;">æœ€è¿‘è®°å½•</h3>
            <ul id="historyList" class="history-list">
                <li class="history-item" style="color:#999;">æš‚æ— è®°å½•</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="secondary" style="width:auto;" onclick="window.toggleTheme()">ğŸŒ— åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
        </div>
    </div>

</div>

<script type="module">
    // -----------------------------------------------------------
    // 1. åˆå§‹åŒ–é…ç½® (Supabase)
    // -----------------------------------------------------------
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // è¿™é‡Œå¡«çš„æ˜¯ä½ åˆšæ‰æä¾›çš„é¡¹ç›®ä¿¡æ¯
    const supabaseUrl = 'https://mjssiorvprbeuvdnbxkw.supabase.co'
    const supabaseKey = 'sb_publishable_0nfL1jDXViLVQUffJfKSFA_vSdCXrco'
    
    const supabase = createClient(supabaseUrl, supabaseKey)

    // å…¨å±€çŠ¶æ€
    let currentUser = null;
    let dietData = {
        isEating: false,      // true=è¿›é£Ÿçª—å£, false=æ–­é£Ÿçª—å£
        lastActionTime: null, // ä¸Šæ¬¡æ“ä½œæ—¶é—´æˆ³
        history: []           // å†å²è®°å½•æ•°ç»„
    };

    // -----------------------------------------------------------
    // 2. è®¤è¯é€»è¾‘ (Auth)
    // -----------------------------------------------------------
    async function initAuth() {
        // å¯åŠ¨æ—¶æ£€æŸ¥ç”¨æˆ·
        const { data: { user } } = await supabase.auth.getUser()
        handleUserChange(user);

        // ç›‘å¬ç™»å½•/é€€å‡º
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                handleUserChange(session.user);
                syncFromCloud(); // ç™»å½•åè‡ªåŠ¨æ‹‰å–äº‘ç«¯æ•°æ®
            } else if (event === 'SIGNED_OUT') {
                handleUserChange(null);
            }
        })
    }

    function handleUserChange(user) {
        currentUser = user;
        if (user) {
            $('#authForm').style.display = 'none';
            $('#app').style.display = 'block';
            $('#userEmailDisplay').innerText = user.email;
            loadLocal(); // å…ˆåŠ è½½æœ¬åœ°ç¼“å­˜ï¼Œç­‰å¾…äº‘ç«¯åŒæ­¥è¦†ç›–
        } else {
            $('#authForm').style.display = 'block';
            $('#app').style.display = 'none';
        }
    }

    // æŒ‚è½½è®¤è¯å‡½æ•°åˆ° window
    window.register = async () => {
        const email = $('#email').value;
        const password = $('#password').value;
        if(!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
        
        const { error } = await supabase.auth.signUp({ email, password });
        if(error) alert('æ³¨å†Œå¤±è´¥: ' + error.message);
        else alert('æ³¨å†ŒæˆåŠŸï¼');
    }

    window.login = async () => {
        const email = $('#email').value;
        const password = $('#password').value;
        if(!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) alert('ç™»å½•å¤±è´¥: ' + error.message);
    }

    window.logout = async () => {
        await supabase.auth.signOut();
        dietData = { isEating: false, lastActionTime: null, history: [] }; // æ¸…ç©ºæœ¬åœ°çŠ¶æ€
    }

    // -----------------------------------------------------------
    // 3. æ•°æ®åŒæ­¥ (Sync)
    // -----------------------------------------------------------
    
    // ä¸Šä¼ åˆ°äº‘ç«¯
    window.syncToCloud = async () => {
        if (!currentUser) return alert('è¯·å…ˆç™»å½•');
        
        const { error } = await supabase
            .from('diet_logs')
            .upsert({ 
                user_id: currentUser.id, 
                data: dietData 
            }, { onConflict: 'user_id' })

        if (error) {
            console.error('åŒæ­¥å¤±è´¥', error);
            alert('åŒæ­¥å¤±è´¥: ' + error.message);
        } else {
            alert('âœ… å·²åŒæ­¥åˆ°äº‘ç«¯');
        }
    }

    // ä»äº‘ç«¯ä¸‹è½½
    async function syncFromCloud() {
        if (!currentUser) return;
        console.log("æ­£åœ¨ä»äº‘ç«¯æ‹‰å–æ•°æ®...");

        const { data, error } = await supabase
            .from('diet_logs')
            .select('data')
            .eq('user_id', currentUser.id)
            .single()

        if (data && data.data) {
            console.log("äº‘ç«¯æ•°æ®ä¸‹è½½æˆåŠŸ:", data.data);
            dietData = data.data; // è¦†ç›–æœ¬åœ°æ•°æ®
            saveLocal();
            renderUI();
        }
    }

    // -----------------------------------------------------------
    // 4. ä¸šåŠ¡é€»è¾‘ (16+8)
    // -----------------------------------------------------------

    function loadLocal() {
        const local = localStorage.getItem('dietData_168');
        if (local) {
            dietData = JSON.parse(local);
        }
        renderUI();
    }

    function saveLocal() {
        localStorage.setItem('dietData_168', JSON.stringify(dietData));
    }

    // åˆ‡æ¢çŠ¶æ€æŒ‰é’®
    window.toggleEating = () => {
        const now = new Date().getTime();
        
        if (dietData.isEating) {
            // ç»“æŸè¿›é£Ÿ -> å¼€å§‹æ–­é£Ÿ
            dietData.isEating = false;
            dietData.lastActionTime = now;
            dietData.history.unshift({ type: 'end', time: now });
        } else {
            // å¼€å§‹è¿›é£Ÿ
            dietData.isEating = true;
            dietData.lastActionTime = now;
            dietData.history.unshift({ type: 'start', time: now });
        }

        saveLocal();
        renderUI();
        window.syncToCloud(); // æ“ä½œåè‡ªåŠ¨å°è¯•åŒæ­¥
    }

    // æ›´æ–°ç•Œé¢
    function renderUI() {
        const btn = $('#actionBtn');
        const badge = $('#statusBadge');
        const targetText = $('#targetTime');

        if (dietData.isEating) {
            // è¿›é£Ÿçª—å£ä¸­
            badge.innerText = "ğŸ” è¿›é£Ÿçª—å£ (8å°æ—¶)";
            badge.style.background = "#e3f9e5";
            badge.style.color = "#34c759";
            btn.innerText = "ç»“æŸè¿›é£Ÿï¼Œå¼€å§‹æ–­é£Ÿ";
            btn.className = "danger";
            
            // è®¡ç®—è¿›é£Ÿç»“æŸç›®æ ‡æ—¶é—´ (ä¸Šæ¬¡æ“ä½œ + 8å°æ—¶)
            if(dietData.lastActionTime) {
                const target = new Date(dietData.lastActionTime + 8 * 60 * 60 * 1000);
                targetText.innerText = `å»ºè®®ç»“æŸæ—¶é—´: ${formatTime(target)}`;
            }
        } else {
            // æ–­é£Ÿä¸­
            badge.innerText = "ğŸ”¥ æ­£åœ¨æ–­é£Ÿ (16å°æ—¶)";
            badge.style.background = "#fff0f0";
            badge.style.color = "#ff3b30";
            btn.innerText = "å¼€å§‹è¿›é£Ÿ";
            btn.className = "success";

            // è®¡ç®—æ–­é£Ÿç»“æŸç›®æ ‡æ—¶é—´ (ä¸Šæ¬¡æ“ä½œ + 16å°æ—¶)
            if(dietData.lastActionTime) {
                const target = new Date(dietData.lastActionTime + 16 * 60 * 60 * 1000);
                targetText.innerText = `æ–­é£Ÿç›®æ ‡è¾¾æˆ: ${formatTime(target)}`;
            } else {
                targetText.innerText = "å‡†å¤‡å¼€å§‹ç¬¬ä¸€æ¬¡æ–­é£Ÿ";
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        const list = $('#historyList');
        if (dietData.history.length === 0) {
            list.innerHTML = '<li class="history-item" style="color:#999;">æš‚æ— è®°å½•</li>';
        } else {
            list.innerHTML = dietData.history.slice(0, 5).map(item => {
                const date = new Date(item.time);
                const timeStr = formatTime(date);
                const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                const label = item.type === 'start' ? 'å¼€å§‹è¿›é£Ÿ' : 'å¼€å§‹æ–­é£Ÿ';
                const color = item.type === 'start' ? 'green' : 'red';
                return `<li class="history-item">
                    <span>${dateStr} ${timeStr}</span>
                    <span style="color:${color}; font-weight:bold;">${label}</span>
                </li>`;
            }).join('');
        }
    }

    // è®¡æ—¶å™¨ (æ¯ç§’åˆ·æ–°)
    setInterval(() => {
        if (!dietData.lastActionTime) return;
        
        const now = new Date().getTime();
        const diff = now - dietData.lastActionTime; // å·²ç»è¿‡äº†å¤šä¹…
        
        // æ ¼å¼åŒ–ä¸º HH:MM:SS
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        
        $('#timerDisplay').innerText = 
            `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }, 1000);

    // è¾…åŠ©å·¥å…·
    const $ = s => document.querySelector(s);
    const formatTime = date => `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;

    window.toggleTheme = () => {
        const html = document.documentElement;
        html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    // å¯åŠ¨
    initAuth();

</script>
</body>
</html>