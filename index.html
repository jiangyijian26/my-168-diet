<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#4F46E5" />
  <meta name="description" content="16+8 é—´æ­‡æ€§æ–­é£ŸåŠ©æ‰‹ (Proç‰ˆ)" />
  <title>16+8 æ–­é£ŸåŠ©æ‰‹ Pro</title>

  <style>
    /* ==================== 1. æ ¸å¿ƒè®¾è®¡ç³»ç»Ÿ ==================== */
    :root {
      --primary: #4F46E5; --primary-hover: #4338CA;
      --success: #10B981; --warning: #F59E0B; --danger: #EF4444;
      --bg-body: #F3F4F6; --bg-card: rgba(255, 255, 255, 0.85);
      --bg-glass: rgba(255, 255, 255, 0.6);
      --text-main: #111827; --text-sec: #6B7280; --text-ter: #9CA3AF;
      --border: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-lg: 0 10px 30px -5px rgba(0,0,0,0.1);
      --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);
      --radius-lg: 24px; --radius-md: 16px;
      --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #050505; --bg-card: rgba(30, 30, 30, 0.8);
        --bg-glass: rgba(40, 40, 40, 0.6);
        --text-main: #F9FAFB; --text-sec: #9CA3AF; --text-ter: #4B5563;
        --border: rgba(255, 255, 255, 0.1);
        --shadow-lg: 0 10px 40px -10px rgba(0,0,0,0.5);
      }
    }

    /* 2. å…¨å±€é‡ç½®ä¸æ’ç‰ˆ */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      margin: 0; padding: 0;
      font-family: var(--font-main);
      background: var(--bg-body);
      color: var(--text-main);
      padding-bottom: env(safe-area-inset-bottom);
      /* åŠ¨æ„ŸèƒŒæ™¯ */
      background-image: 
        radial-gradient(circle at 10% 0%, rgba(79, 70, 229, 0.15), transparent 40%),
        radial-gradient(circle at 90% 100%, rgba(16, 185, 129, 0.1), transparent 40%);
      background-attachment: fixed;
    }

    /* å®¹å™¨ */
    .container {
      max-width: 480px; margin: 0 auto;
      padding: calc(20px + env(safe-area-inset-top)) 20px 100px;
    }

    /* 3. ç»„ä»¶æ ·å¼ */
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .topbar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px;
    }
    .brand h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .brand span { font-size: 12px; color: var(--primary); font-weight: 600; background: rgba(79,70,229,0.1); padding: 2px 6px; border-radius: 6px; margin-left: 6px; vertical-align: middle; }
    .nav-btn {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-main);
      display: grid; place-items: center; cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn:active { transform: scale(0.92); }

    /* å¡ç‰‡é€šç”¨ */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 24px; margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    
    /* æ¨¡å¼åˆ‡æ¢å™¨ */
    .mode-tabs {
      display: flex; background: rgba(0,0,0,0.04);
      padding: 4px; border-radius: 14px; margin-bottom: 24px;
    }
    @media (prefers-color-scheme: dark) { .mode-tabs { background: rgba(255,255,255,0.06); } }
    .tab {
      flex: 1; text-align: center; padding: 10px 0; font-size: 13px; font-weight: 600;
      color: var(--text-sec); border-radius: 10px; cursor: pointer; transition: 0.3s var(--ease-spring);
    }
    .tab.active {
      background: var(--bg-card); color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* è®¡æ—¶å™¨åœ†ç¯ (æ ¸å¿ƒè§†è§‰) */
    .timer-wrap { position: relative; width: 240px; height: 240px; margin: 30px auto; }
    .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .timer-track { fill: none; stroke: var(--border); stroke-width: 8; stroke-linecap: round; }
    .timer-progress {
      fill: none; stroke: var(--primary); stroke-width: 8; stroke-linecap: round;
      stroke-dasharray: 660; stroke-dashoffset: 660; /* 2 * PI * 105 */
      transition: stroke-dashoffset 1s linear, stroke 0.3s;
      filter: drop-shadow(0 0 4px var(--primary));
    }
    .timer-content {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .timer-time { font-size: 42px; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -1px; }
    .timer-label { margin-top: 8px; font-size: 14px; font-weight: 600; color: var(--text-sec); }
    .timer-badge {
      margin-top: 12px; padding: 6px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
    
    /* çŠ¶æ€é¢œè‰² */
    .status-fasting .timer-progress { stroke: var(--success); filter: drop-shadow(0 0 6px var(--success)); }
    .status-fasting .timer-time { color: var(--success); }
    .status-fasting .timer-badge { background: rgba(16, 185, 129, 0.1); color: var(--success); }

    .status-eating .timer-progress { stroke: var(--primary); }
    .status-eating .timer-time { color: var(--primary); }
    .status-eating .timer-badge { background: rgba(79, 70, 229, 0.1); color: var(--primary); }

    /* è¿›é£Ÿæ‰“å¡å¡ç‰‡ */
    .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .meal-item {
      padding: 20px; text-align: center; border: 2px solid transparent;
      display: flex; flex-direction: column; align-items: center;
    }
    .meal-item.active { border-color: var(--primary); background: rgba(79, 70, 229, 0.03); }
    .meal-item.done { border-color: var(--success); background: rgba(16, 185, 129, 0.03); }
    
    .meal-icon { font-size: 28px; margin-bottom: 8px; filter: grayscale(1); transition: 0.3s; }
    .active .meal-icon, .done .meal-icon { filter: grayscale(0); transform: scale(1.1); }
    
    .meal-time { font-size: 12px; color: var(--text-ter); margin: 4px 0 12px; font-weight: 500; }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      width: 100%; padding: 14px; border: none; border-radius: 14px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; position: relative; overflow: hidden;
      display: flex; justify-content: center; align-items: center; gap: 8px;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(79,70,229,0.3); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-done { background: var(--success); color: #fff; pointer-events: none; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
    .btn-ghost { background: transparent; color: var(--text-sec); font-size: 13px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* åŠ è½½ Spinner */
    .spinner {
      width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none;
    }
    .btn.loading .spinner { display: block; }
    .btn.loading span { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ç»Ÿè®¡æ•°æ® */
    .stats-row { display: flex; justify-content: space-around; text-align: center; }
    .stat-val { font-size: 24px; font-weight: 800; color: var(--text-main); display: block; }
    .stat-label { font-size: 12px; color: var(--text-sec); margin-top: 4px; }

    /* å‘¨è§†å›¾ */
    .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .day-cell {
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      padding: 10px 0; border-radius: 12px; font-size: 12px; color: var(--text-sec);
    }
    .day-cell.today { background: var(--bg-body); font-weight: bold; color: var(--primary); }
    .day-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: 0.3s; }
    .day-cell.success .day-dot { background: var(--success); transform: scale(1.2); }

    /* å¿«æ·æ“ä½œ */
    .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .control-group { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.03); border-radius: 12px; padding: 4px; margin-top: 10px; }
    .mini-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; font-size: 16px; }
    .weight-input { width: 60px; background: transparent; border: none; text-align: center; font-weight: 700; font-size: 16px; color: var(--text-main); }

    /* å¼¹çª— & Toast */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      z-index: 99; opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .overlay.show { opacity: 1; pointer-events: auto; }
    
    .sheet {
      position: fixed; bottom: 20px; left: 20px; right: 20px;
      background: var(--bg-card); backdrop-filter: blur(25px);
      border-radius: 30px; padding: 24px; z-index: 100;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      transform: translateY(120%); transition: 0.4s var(--ease-spring);
      max-width: 500px; margin: 0 auto;
    }
    .sheet.show { transform: translateY(0); }
    
    .input-group { margin-bottom: 16px; }
    .input-field {
      width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border);
      background: rgba(0,0,0,0.02); font-size: 16px; color: var(--text-main);
      transition: 0.2s;
    }
    .input-field:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(79,70,229,0.1); }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      padding: 12px 24px; border-radius: 50px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 10px; z-index: 200;
      transition: 0.4s var(--ease-spring); border: 1px solid var(--border);
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast-icon { font-size: 18px; }
    .toast-msg { font-size: 14px; font-weight: 600; color: var(--text-main); }

    /* åŠ¨ç”» */
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79,70,229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79,70,229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79,70,229, 0); } }
  </style>
</head>
<body>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>Fasting Pro <span>CLOUD</span></h1>
      </div>
      <div style="display:flex; gap:12px;">
        <button class="nav-btn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
        <button class="nav-btn" id="userBtn" title="è´¦å·">ğŸ‘¤</button>
      </div>
    </div>

    <div class="mode-tabs">
      <div class="tab" data-mode="12">12:12 è½»æ¾</div>
      <div class="tab" data-mode="14">14:10 è¿›é˜¶</div>
      <div class="tab active" data-mode="16">16:8 ç‡ƒè„‚</div>
      <div class="tab" data-mode="18">18:6 æŒ‘æˆ˜</div>
    </div>

    <div class="card" id="timerCard">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 220 220">
          <circle class="timer-track" cx="110" cy="110" r="105"></circle>
          <circle class="timer-progress" id="progressRing" cx="110" cy="110" r="105"></circle>
        </svg>
        <div class="timer-content">
          <div class="timer-time" id="timerDisplay">--:--</div>
          <div class="timer-label" id="timerLabel">ç‚¹å‡»å¼€å§‹</div>
          <div class="timer-badge">
            <div class="dot"></div>
            <span id="statusText">å‡†å¤‡å°±ç»ª</span>
          </div>
        </div>
      </div>
    </div>

    <div class="meal-grid">
      <div class="card meal-item" id="breakfastCard">
        <div class="meal-icon">ğŸ³</div>
        <div style="font-weight:700; font-size:15px;">å¼€å§‹è¿›é£Ÿ</div>
        <div class="meal-time" id="breakfastTime">å»ºè®® 10:00 - 13:00</div>
        <button class="btn btn-primary" id="breakfastBtn">
          <span>æ‰“å¡ç¬¬ä¸€é¤</span><div class="spinner"></div>
        </button>
      </div>
      
      <div class="card meal-item" id="dinnerCard">
        <div class="meal-icon">ğŸŒ™</div>
        <div style="font-weight:700; font-size:15px;">ç»“æŸè¿›é£Ÿ</div>
        <div class="meal-time" id="dinnerTime">å°šæœªå¼€å§‹</div>
        <button class="btn btn-outline" id="dinnerBtn" disabled>
          <span>ç»“æŸçª—å£</span><div class="spinner"></div>
        </button>
      </div>
    </div>

    <div class="action-row">
      <div class="card" style="margin:0;">
        <div style="font-size:13px; color:var(--text-sec); font-weight:600;">ğŸ’§ é¥®æ°´ (æ¯)</div>
        <div class="control-group">
          <button class="mini-btn" id="waterMinus">-</button>
          <span style="font-weight:800; font-size:20px; color:var(--primary);" id="waterCount">0</span>
          <button class="mini-btn" id="waterPlus" style="color:var(--primary);">+</button>
        </div>
      </div>
      <div class="card" style="margin:0;">
        <div style="font-size:13px; color:var(--text-sec); font-weight:600;">âš–ï¸ ä½“é‡ (kg)</div>
        <div class="control-group">
          <input type="number" class="weight-input" id="weightInput" placeholder="0.0">
          <button class="mini-btn" id="weightSaveBtn" style="width:auto; padding:0 10px; font-size:12px;">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stats-row">
        <div><span class="stat-val" id="streakDays">0</span><span class="stat-label">ğŸ”¥ è¿ç»­å¤©æ•°</span></div>
        <div><span class="stat-val" id="totalDays">0</span><span class="stat-label">ğŸ“… ç´¯è®¡æ‰“å¡</span></div>
        <div><span class="stat-val" id="successRate">0%</span><span class="stat-label">ğŸ“ˆ å®Œæˆç‡</span></div>
      </div>
      <div style="height:1px; background:var(--border); margin:20px 0;"></div>
      <div class="week-grid" id="weekGrid"></div>
    </div>

    <div style="text-align:center;">
      <button class="btn btn-ghost" id="resetBtn">é‡ç½®ä»Šæ—¥æ•°æ®</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="authSheet">
    <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
      <h2 style="margin:0; font-size:22px;">â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
      <button id="authClose" style="background:none; border:none; font-size:20px; color:var(--text-ter);">âœ•</button>
    </div>

    <div id="authForm">
      <div class="input-group">
        <input type="email" class="input-field" id="authEmail" placeholder="é‚®ç®± (name@example.com)">
      </div>
      <div class="input-group">
        <input type="password" class="input-field" id="authPwd" placeholder="å¯†ç  (6ä½ä»¥ä¸Š)">
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <button class="btn btn-primary" id="btnLogin"><span>ç™»å½•</span><div class="spinner"></div></button>
        <button class="btn btn-outline" id="btnRegister"><span>æ³¨å†Œ</span><div class="spinner"></div></button>
      </div>
      <div style="text-align:center; margin-top:16px;">
        <span id="btnForgot" style="font-size:13px; color:var(--text-sec); text-decoration:underline; cursor:pointer;">å¿˜è®°å¯†ç ï¼Ÿ</span>
      </div>
    </div>

    <div id="userPanel" style="display:none; text-align:center;">
      <div style="font-size:48px; margin-bottom:16px;">ğŸ‰</div>
      <h3 id="userEmailDisplay" style="margin:0 0 8px;"></h3>
      <p style="color:var(--text-sec); font-size:14px; margin-bottom:24px;">æ•°æ®å·²å®‰å…¨åŒæ­¥è‡³äº‘ç«¯</p>
      <button class="btn btn-danger" id="btnLogout">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="toast-icon">âœ…</div>
    <div class="toast-msg">æ“ä½œæˆåŠŸ</div>
  </div>

  <script type="module">
    // 1. Firebase å¼•å…¥
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ ä½ çš„ä¸“å±é…ç½® (è¯·å‹¿ä¿®æ”¹)
    const firebaseConfig = {
      apiKey: "AIzaSyDxikMU7cksuU98yzunytYiLh1JwBWLs1E",
      authDomain: "app-b8dc2.firebaseapp.com",
      projectId: "app-b8dc2",
      storageBucket: "app-b8dc2.firebasestorage.app",
      messagingSenderId: "472746079554",
      appId: "1:472746079554:web:14403d7ff50b580d6084db",
      measurementId: "G-EVF2MNHHYG"
    };

    // åˆå§‹åŒ–æœåŠ¡
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { enableIndexedDbPersistence(db); } catch(e) { console.log("Persistence disabled"); }

    // 2. å¸¸é‡å®šä¹‰
    const CONFIG = { KEY: 'fasting_pro_v1', HIST: 'history_pro_v1' };
    const MODES = {
      12: { eat: 12, fast: 12 },
      14: { eat: 10, fast: 14 },
      16: { eat: 8, fast: 16 },
      18: { eat: 6, fast: 18 }
    };

    // 3. çŠ¶æ€ç®¡ç†
    let state = {
      date: new Date().toDateString(),
      mode: 16,
      start: null, // è¿›é£Ÿå¼€å§‹æ—¶é—´æˆ³
      end: null,   // è¿›é£Ÿç»“æŸæ—¶é—´æˆ³
      meals: { b: null, d: null },
      water: 0,
      weight: null
    };
    let history = []; // å†å²è®°å½•æ•°ç»„
    let currentUser = null;

    // 4. UI è¾…åŠ©å‡½æ•°
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    
    // æ¼‚äº®çš„ Toast æç¤º
    const showToast = (msg, icon = 'âœ…', type = 'normal') => {
      const t = $('toast');
      t.querySelector('.toast-msg').innerText = msg;
      t.querySelector('.toast-icon').innerText = icon;
      t.style.borderColor = type === 'error' ? 'var(--danger)' : 'var(--border)';
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    // æŒ‰é’®åŠ è½½çŠ¶æ€æ§åˆ¶
    const setLoading = (btnId, isLoading) => {
      const btn = $(btnId);
      if(isLoading) {
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    };

    // æ ¼å¼åŒ–æ—¶é—´
    const fmtTime = ts => new Date(ts).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

    // 5. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

    // ä¿å­˜æ•°æ® (æœ¬åœ° + äº‘ç«¯)
    const save = async () => {
      localStorage.setItem(CONFIG.KEY, JSON.stringify(state));
      localStorage.setItem(CONFIG.HIST, JSON.stringify(history));
      
      if (currentUser) {
        try {
          await setDoc(doc(db, "users", currentUser.uid), {
            state,
            history,
            lastUpdated: Date.now() // æ—¶é—´æˆ³ç”¨äºç‰ˆæœ¬æ§åˆ¶
          }, { merge: true });
        } catch (e) {
          console.error("Sync error", e);
        }
      }
    };

    // åŠ è½½æ•°æ®
    const load = async () => {
      // Step 1: å…ˆè¯»æœ¬åœ°ï¼Œç§’å¼€
      const locS = localStorage.getItem(CONFIG.KEY);
      const locH = localStorage.getItem(CONFIG.HIST);
      if (locS) state = { ...state, ...JSON.parse(locS) };
      if (locH) history = JSON.parse(locH);
      
      checkDate(); // æ£€æŸ¥è·¨å¤©
      updateUI();
    };

    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦å˜æ›´
    const checkDate = () => {
      const today = new Date().toDateString();
      if (state.date !== today) {
        // å½’æ¡£æ—§æ•°æ® (åªæœ‰å½“æœ‰è¿‡æ“ä½œæ‰å½’æ¡£)
        if (state.start || state.water > 0 || state.weight) {
          const isCompleted = state.meals.b && state.meals.d;
          // é˜²æ­¢é‡å¤å½’æ¡£
          if (!history.find(h => h.date === state.date)) {
            history.unshift({
              date: state.date,
              completed: isCompleted,
              mode: state.mode,
              weight: state.weight
            });
            // åªä¿ç•™æœ€è¿‘ 60 å¤©
            if (history.length > 60) history.pop();
          }
        }
        // é‡ç½®ä»Šæ—¥çŠ¶æ€
        state = {
          date: today,
          mode: state.mode, // ä¿æŒæ¨¡å¼
          start: null, end: null,
          meals: { b: null, d: null },
          water: 0,
          weight: state.weight // ä¿ç•™ä½“é‡
        };
        save();
      }
    };

    // äº‘ç«¯åŒæ­¥é€»è¾‘
    const syncFromCloud = async () => {
      if (!currentUser) return;
      try {
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        if (snap.exists()) {
          const cloudData = snap.data();
          // ç®€å•çš„ç­–ç•¥ï¼šäº‘ç«¯æœ‰æ•°æ®å°±è¦†ç›–æœ¬åœ° (å¯ä»¥æ ¹æ® lastUpdated ä¼˜åŒ–)
          if (cloudData.state) state = { ...state, ...cloudData.state };
          if (cloudData.history) history = cloudData.history;
          
          checkDate(); // å†æ¬¡æ£€æŸ¥æ—¥æœŸç¡®ä¿æ­£ç¡®
          save(); // å›å†™æœ¬åœ°
          updateUI();
          showToast('æ•°æ®å·²åŒæ­¥', 'â˜ï¸');
        } else {
          // æ–°ç”¨æˆ·ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®
          save();
        }
      } catch (e) {
        console.error(e);
      }
    };

    // è¿èƒœè®¡ç®—ç®—æ³•
    const calculateStats = () => {
      // 1. æ€»æ‰“å¡å¤©æ•°
      const total = history.filter(h => h.completed).length + (state.meals.b && state.meals.d ? 1 : 0);
      
      // 2. è¿èƒœè®¡ç®—
      // å°†æ‰€æœ‰å®Œæˆçš„æ—¥æœŸè½¬ä¸ºæ—¶é—´æˆ³
      let completedDates = history.filter(h => h.completed).map(h => new Date(h.date).setHours(0,0,0,0));
      // å¦‚æœä»Šå¤©å®Œæˆäº†ï¼ŒåŠ è¿›å»
      if (state.meals.b && state.meals.d) completedDates.unshift(new Date(state.date).setHours(0,0,0,0));
      
      completedDates = [...new Set(completedDates)].sort((a,b) => b-a); // å»é‡å¹¶é™åº
      
      let streak = 0;
      if (completedDates.length > 0) {
        const today = new Date().setHours(0,0,0,0);
        const yesterday = today - 86400000;
        
        // è¿èƒœå¿…é¡»ä»ä»Šå¤©æˆ–æ˜¨å¤©å¼€å§‹
        if (completedDates[0] === today || completedDates[0] === yesterday) {
          streak = 1;
          for (let i = 0; i < completedDates.length - 1; i++) {
            // å¦‚æœå‰ä¸€å¤©æ˜¯åä¸€å¤©çš„"æ˜å¤©" (å·®å€¼ä¸€å¤©)
            if ((completedDates[i] - completedDates[i+1]) === 86400000) {
              streak++;
            } else {
              break;
            }
          }
        }
      }
      
      // 3. æˆåŠŸç‡
      const rate = history.length > 0 ? Math.round((total / (history.length + 1)) * 100) : (total > 0 ? 100 : 0);

      $('streakDays').innerText = streak;
      $('totalDays').innerText = total;
      $('successRate').innerText = rate + '%';
    };

    // 6. UI æ›´æ–°é€»è¾‘
    const updateUI = () => {
      // æ¨¡å¼é«˜äº®
      $$('.tab').forEach(t => t.classList.toggle('active', +t.dataset.mode === state.mode));
      
      // è¿›é£ŸæŒ‰é’®çŠ¶æ€
      const bBtn = $('breakfastBtn');
      const dBtn = $('dinnerBtn');
      const timerCard = $('timerCard');
      const bCard = $('breakfastCard');
      const dCard = $('dinnerCard');

      // çŠ¶æ€æœºè§†è§‰åˆ‡æ¢
      if (!state.meals.b) {
        // é˜¶æ®µ 1: ç­‰å¾…å¼€å§‹
        bBtn.innerHTML = '<span>å¼€å§‹è¿›é£Ÿ</span>'; bBtn.className = 'btn btn-primary'; bBtn.disabled = false;
        $('breakfastTime').innerText = 'å»ºè®® 10:00 - 13:00';
        bCard.className = 'card meal-item active';
        
        dBtn.innerHTML = '<span>å°šæœªå¼€å§‹</span>'; dBtn.className = 'btn btn-outline'; dBtn.disabled = true;
        dCard.className = 'card meal-item';
        
        timerCard.className = 'card status-fasting'; // é»˜è®¤çŠ¶æ€
        $('statusText').innerText = 'ç¦é£ŸæœŸ / å¾…å¼€å§‹';

      } else if (!state.meals.d) {
        // é˜¶æ®µ 2: è¿›é£Ÿçª—å£ä¸­
        bBtn.innerHTML = '<span>å·²æ‰“å¡ ' + state.meals.b + '</span>'; bBtn.className = 'btn btn-done';
        bCard.className = 'card meal-item done';
        
        dBtn.innerHTML = '<span>ç»“æŸè¿›é£Ÿ</span>'; dBtn.className = 'btn btn-primary'; dBtn.disabled = false;
        $('dinnerTime').innerText = 'çª—å£å°†äº ' + fmtTime(state.end) + ' å…³é—­';
        dCard.className = 'card meal-item active';

        timerCard.className = 'card status-eating';
        $('statusText').innerText = 'è¿›é£Ÿçª—å£å¼€æ”¾ä¸­';

      } else {
        // é˜¶æ®µ 3: ä»Šæ—¥ç»“æŸ
        bBtn.innerHTML = '<span>å·²æ‰“å¡ ' + state.meals.b + '</span>'; bBtn.className = 'btn btn-done';
        bCard.className = 'card meal-item done';
        
        dBtn.innerHTML = '<span>å·²ç»“æŸ ' + state.meals.d + '</span>'; dBtn.className = 'btn btn-done';
        dCard.className = 'card meal-item done';

        timerCard.className = 'card status-fasting';
        $('statusText').innerText = 'ç¦é£ŸæœŸ / èº«ä½“ä¿®å¤ä¸­';
      }

      // å¿«æ·æ•°æ®
      $('waterCount').innerText = state.water;
      if (state.weight) $('weightInput').value = state.weight;

      // å›¾è¡¨ä¸å‘¨è§†å›¾
      calculateStats();
      renderWeek();
      
      // ç«‹å³è§¦å‘ä¸€æ¬¡å€’è®¡æ—¶åˆ·æ–°
      updateTimerDisplay();
    };

    // æ¸²æŸ“å‘¨è§†å›¾
    const renderWeek = () => {
      const today = new Date();
      const dayOfWeek = today.getDay() || 7; // 1-7 (å‘¨ä¸€åˆ°å‘¨æ—¥)
      const monday = new Date(today);
      monday.setDate(today.getDate() - dayOfWeek + 1);

      let html = '';
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const dStr = d.toDateString();
        const isToday = dStr === state.date;
        
        // æŸ¥æ‰¾è®°å½•
        let statusClass = '';
        if (isToday) {
          if (state.meals.b && state.meals.d) statusClass = 'success';
        } else {
          const h = history.find(item => item.date === dStr);
          if (h && h.completed) statusClass = 'success';
        }

        const weekNames = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
        html += `
          <div class="day-cell ${isToday ? 'today' : ''} ${statusClass}">
            <span>${weekNames[i]}</span>
            <span>${d.getDate()}</span>
            <div class="day-dot"></div>
          </div>
        `;
      }
      $('weekGrid').innerHTML = html;
    };

    // è®¡æ—¶å™¨æ ¸å¿ƒåŠ¨ç”»
    const updateTimerDisplay = () => {
      const ring = $('progressRing');
      const circumference = 660; // 2 * PI * 105
      
      if (!state.start) {
        // é—²ç½®çŠ¶æ€
        $('timerDisplay').innerText = '--:--';
        $('timerLabel').innerText = 'ç‚¹å‡»ç¬¬ä¸€é¤æ‰“å¡';
        ring.style.strokeDashoffset = circumference;
        return;
      }

      const now = Date.now();
      let percentage = 0;
      let labelText = '';
      let displayTime = '';

      if (!state.meals.d) {
        // è¿›é£Ÿçª—å£å€’è®¡æ—¶
        const remaining = state.end - now;
        const totalDuration = MODES[state.mode].eat * 3600000;
        
        if (remaining > 0) {
          percentage = ((totalDuration - remaining) / totalDuration);
          const h = Math.floor(remaining / 3600000);
          const m = Math.floor((remaining % 3600000) / 60000);
          const s = Math.floor((remaining % 60000) / 1000);
          displayTime = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
          labelText = 'è·ç¦»çª—å£å…³é—­';
        } else {
          displayTime = '00:00:00';
          labelText = 'çª—å£å·²è¶…æ—¶';
          percentage = 1;
        }
      } else {
        // ç¦é£Ÿè®¡æ—¶ (ä»æ™šé¤ç»“æŸå¼€å§‹ç®—)
        // è®¡ç®—ä¸‹ä¸€é¤å¼€å§‹ç›®æ ‡ (å‡è®¾æ˜å¤©åŒä¸€æ—¶é—´)
        // ç®€å•å±•ç¤ºï¼šå·²ç¦é£Ÿæ—¶é•¿
        const dinnerTime = new Date().setHours(parseInt(state.meals.d.split(':')[0]), parseInt(state.meals.d.split(':')[1])); 
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºå½“å‰æ—¶é—´ï¼Œè¡¨ç¤ºæ­£åœ¨æµé€
        const d = new Date();
        displayTime = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        labelText = 'å½“å‰æ—¶é—´';
        percentage = 1; // æ»¡åœˆç»¿è‰²
      }

      // æ›´æ–° UI
      $('timerDisplay').innerText = displayTime;
      $('timerLabel').innerText = labelText;
      
      // åœ†ç¯åŠ¨ç”»
      const offset = circumference - (percentage * circumference);
      ring.style.strokeDashoffset = offset;
    };

    // 7. äº‹ä»¶ç›‘å¬
    
    // æ‰“å¡æ“ä½œ
    $('breakfastBtn').onclick = () => {
      const h = new Date().getHours();
      // è½¯é™åˆ¶ï¼šå¦‚æœå¤ªæ—©ç»™ä¸ªæç¤ºï¼Œä½†ä¸é˜»æ­¢
      if(h < 6) showToast('ç¡®å®è¦è¿™ä¹ˆæ—©å¼€å§‹å—ï¼Ÿ', 'ğŸ¤”', 'warning');
      
      state.start = Date.now();
      state.end = state.start + (MODES[state.mode].eat * 3600000);
      state.meals.b = fmtTime(state.start);
      save(); updateUI();
      showToast('è¿›é£Ÿçª—å£å·²å¼€å¯');
    };

    $('dinnerBtn').onclick = () => {
      state.meals.d = fmtTime(Date.now());
      save(); updateUI();
      showToast('ä»Šæ—¥æŒ‘æˆ˜å®Œæˆï¼', 'ğŸ‰');
    };

    // æ°´ä¸ä½“é‡
    $('waterPlus').onclick = () => { state.water++; save(); updateUI(); };
    $('waterMinus').onclick = () => { if(state.water>0) state.water--; save(); updateUI(); };
    $('weightSaveBtn').onclick = () => {
      const val = $('weightInput').value;
      if(val) {
        state.weight = val;
        save();
        showToast('ä½“é‡å·²è®°å½•');
      }
    };

    // æ¨¡å¼åˆ‡æ¢
    $$('.tab').forEach(tab => {
      tab.onclick = () => {
        if (state.start) {
          showToast('æ‰“å¡åæ— æ³•åˆ‡æ¢æ¨¡å¼', 'ğŸš«', 'error');
          return;
        }
        state.mode = +tab.dataset.mode;
        save(); updateUI();
      };
    });

    // é‡ç½®
    $('resetBtn').onclick = () => {
      if(confirm('ç¡®å®šè¦æ¸…é™¤ä»Šå¤©çš„è®°å½•å—ï¼Ÿ')) {
        state.start = null; state.end = null;
        state.meals = {b:null, d:null};
        state.water = 0;
        save(); updateUI();
        showToast('å·²é‡ç½®');
      }
    };

    // Auth äº¤äº’
    const toggleSheet = (show) => {
      const el = $('authSheet');
      const ov = $('overlay');
      if(show) { el.classList.add('show'); ov.classList.add('show'); }
      else { el.classList.remove('show'); ov.classList.remove('show'); }
    };
    $('userBtn').onclick = () => toggleSheet(true);
    $('authClose').onclick = () => toggleSheet(false);
    $('overlay').onclick = () => toggleSheet(false);

    // ç™»å½•é€»è¾‘
    $('btnLogin').onclick = async () => {
      const email = $('authEmail').value;
      const pwd = $('authPwd').value;
      if (!email || !pwd) return showToast('è¯·è¾“å…¥è´¦å·å¯†ç ', 'âš ï¸', 'error');
      
      setLoading('btnLogin', true);
      try {
        await signInWithEmailAndPassword(auth, email, pwd);
        toggleSheet(false);
        showToast('æ¬¢è¿å›æ¥');
      } catch(e) {
        showToast('ç™»å½•å¤±è´¥: è¯·æ£€æŸ¥å¯†ç ', 'âŒ', 'error');
      }
      setLoading('btnLogin', false);
    };

    // æ³¨å†Œé€»è¾‘
    $('btnRegister').onclick = async () => {
      const email = $('authEmail').value;
      const pwd = $('authPwd').value;
      if (pwd.length < 6) return showToast('å¯†ç éœ€è‡³å°‘6ä½', 'âš ï¸', 'error');
      
      setLoading('btnRegister', true);
      try {
        await createUserWithEmailAndPassword(auth, email, pwd);
        toggleSheet(false);
        showToast('æ³¨å†ŒæˆåŠŸï¼');
      } catch(e) {
        showToast('æ³¨å†Œå¤±è´¥: ' + e.message, 'âŒ', 'error');
      }
      setLoading('btnRegister', false);
    };

    // é€€å‡ºé€»è¾‘
    $('btnLogout').onclick = async () => {
      await signOut(auth);
      toggleSheet(false);
      showToast('å·²é€€å‡ºç™»å½•');
    };
    
    // å¿˜è®°å¯†ç 
    $('btnForgot').onclick = async () => {
      const email = $('authEmail').value;
      if(!email) return showToast('è¯·å…ˆè¾“å…¥é‚®ç®±', 'ğŸ“§', 'error');
      try {
        await sendPasswordResetEmail(auth, email);
        showToast('é‡ç½®é‚®ä»¶å·²å‘é€');
      } catch(e) {
        showToast('å‘é€å¤±è´¥: ' + e.message, 'âŒ', 'error');
      }
    };

    // ç›‘å¬ Auth çŠ¶æ€
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        $('authForm').style.display = 'none';
        $('userPanel').style.display = 'block';
        $('userEmailDisplay').innerText = user.email;
        $('userBtn').innerText = 'ğŸŸ¢';
        syncFromCloud(); // ç™»å½•å³åŒæ­¥
      } else {
        $('authForm').style.display = 'block';
        $('userPanel').style.display = 'none';
        $('userBtn').innerText = 'ğŸ‘¤';
      }
    });
    
    // ä¸»é¢˜åˆ‡æ¢
    $('themeBtn').onclick = () => {
      const root = document.documentElement;
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
    };

    // å¯åŠ¨å¼•æ“
    load();
    setInterval(updateTimerDisplay, 1000); // è®¡æ—¶å™¨å¿ƒè·³

  </script>
</body>
</html>